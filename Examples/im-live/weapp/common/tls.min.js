"use strict";

function _typeof(obj) { "@babel/helpers - typeof"; if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

!function (t, e) {
  "object" == (typeof exports === "undefined" ? "undefined" : _typeof(exports)) && "object" == (typeof module === "undefined" ? "undefined" : _typeof(module)) ? module.exports = e() : "function" == typeof define && define.amd ? define([], e) : "object" == (typeof exports === "undefined" ? "undefined" : _typeof(exports)) ? exports["im-live-sells"] = e() : t["im-live-sells"] = e();
}(window, function () {
  return function (t) {
    var e = {};

    function n(o) {
      if (e[o]) return e[o].exports;
      var r = e[o] = {
        i: o,
        l: !1,
        exports: {}
      };
      return t[o].call(r.exports, r, r.exports, n), r.l = !0, r.exports;
    }

    return n.m = t, n.c = e, n.d = function (t, e, o) {
      n.o(t, e) || Object.defineProperty(t, e, {
        enumerable: !0,
        get: o
      });
    }, n.r = function (t) {
      "undefined" != typeof Symbol && Symbol.toStringTag && Object.defineProperty(t, Symbol.toStringTag, {
        value: "Module"
      }), Object.defineProperty(t, "__esModule", {
        value: !0
      });
    }, n.t = function (t, e) {
      if (1 & e && (t = n(t)), 8 & e) return t;
      if (4 & e && "object" == _typeof(t) && t && t.__esModule) return t;
      var o = Object.create(null);
      if (n.r(o), Object.defineProperty(o, "default", {
        enumerable: !0,
        value: t
      }), 2 & e && "string" != typeof t) for (var r in t) {
        n.d(o, r, function (e) {
          return t[e];
        }.bind(null, r));
      }
      return o;
    }, n.n = function (t) {
      var e = t && t.__esModule ? function () {
        return t["default"];
      } : function () {
        return t;
      };
      return n.d(e, "a", e), e;
    }, n.o = function (t, e) {
      return Object.prototype.hasOwnProperty.call(t, e);
    }, n.p = "", n(n.s = 0);
  }([function (t, e, n) {
    "use strict";

    Object.defineProperty(e, "__esModule", {
      value: !0
    });
    var o = n(1);
    e["default"] = o["default"];
  }, function (t, e, n) {
    "use strict";

    var o = this && this.__awaiter || function (t, e, n, o) {
      return new (n || (n = Promise))(function (r, i) {
        function s(t) {
          try {
            a(o.next(t));
          } catch (t) {
            i(t);
          }
        }

        function u(t) {
          try {
            a(o["throw"](t));
          } catch (t) {
            i(t);
          }
        }

        function a(t) {
          var e;
          t.done ? r(t.value) : (e = t.value, e instanceof n ? e : new n(function (t) {
            t(e);
          })).then(s, u);
        }

        a((o = o.apply(t, e || [])).next());
      });
    },
        r = this && this.__generator || function (t, e) {
      var n,
          o,
          r,
          i,
          s = {
        label: 0,
        sent: function sent() {
          if (1 & r[0]) throw r[1];
          return r[1];
        },
        trys: [],
        ops: []
      };
      return i = {
        next: u(0),
        "throw": u(1),
        "return": u(2)
      }, "function" == typeof Symbol && (i[Symbol.iterator] = function () {
        return this;
      }), i;

      function u(i) {
        return function (u) {
          return function (i) {
            if (n) throw new TypeError("Generator is already executing.");

            for (; s;) {
              try {
                if (n = 1, o && (r = 2 & i[0] ? o["return"] : i[0] ? o["throw"] || ((r = o["return"]) && r.call(o), 0) : o.next) && !(r = r.call(o, i[1])).done) return r;

                switch (o = 0, r && (i = [2 & i[0], r.value]), i[0]) {
                  case 0:
                  case 1:
                    r = i;
                    break;

                  case 4:
                    return s.label++, {
                      value: i[1],
                      done: !1
                    };

                  case 5:
                    s.label++, o = i[1], i = [0];
                    continue;

                  case 7:
                    i = s.ops.pop(), s.trys.pop();
                    continue;

                  default:
                    if (!(r = s.trys, (r = r.length > 0 && r[r.length - 1]) || 6 !== i[0] && 2 !== i[0])) {
                      s = 0;
                      continue;
                    }

                    if (3 === i[0] && (!r || i[1] > r[0] && i[1] < r[3])) {
                      s.label = i[1];
                      break;
                    }

                    if (6 === i[0] && s.label < r[1]) {
                      s.label = r[1], r = i;
                      break;
                    }

                    if (r && s.label < r[2]) {
                      s.label = r[2], s.ops.push(i);
                      break;
                    }

                    r[2] && s.ops.pop(), s.trys.pop();
                    continue;
                }

                i = e.call(t, s);
              } catch (t) {
                i = [6, t], o = 0;
              } finally {
                n = r = 0;
              }
            }

            if (5 & i[0]) throw i[1];
            return {
              value: i[0] ? i[1] : void 0,
              done: !0
            };
          }([i, u]);
        };
      }
    };

    Object.defineProperty(e, "__esModule", {
      value: !0
    });

    var i = n(2),
        s = n(3),
        u = n(4),
        a = function () {
      function t(t) {
        this.tim = null, this.userName = "", this.userSig = "", this.SDKAppID = 0, this.roomID = "", this.groupCustomFieldFilter = ["addgoods", "room_status"], this.userInfo = {}, this.groupInfo = {}, this.isSdkReady = !1, this.eventBus = new u.EventBus(), this.event = {}, this.initComponentMemberValue(t), this.initIMSDK(t);
      }

      return t.prototype.initIMSDK = function (t) {
        var e = this;
        return new Promise(function (n, i) {
          return o(e, void 0, void 0, function () {
            var e;
            return r(this, function (o) {
              switch (o.label) {
                case 0:
                  return this.TIM = t.TIM, this.tim = this.TIM.create({
                    SDKAppID: t.SDKAppID
                  }), this.tim.setLogLevel(0), this.tim.on(this.TIM.EVENT.SDK_READY, this.sdkReady.bind(this)), this.tim.on(this.TIM.EVENT.MESSAGE_RECEIVED, this.messageRecieved.bind(this)), this.tim.on(this.TIM.EVENT.PROFILE_UPDATED, this.profileUpdate.bind(this)), this.tim.on(this.TIM.EVENT.ERROR, this.error.bind(this)), this.tim.on(this.TIM.EVENT.SDK_NOT_READY, this.sdkNotReady.bind(this)), this.tim.on(this.TIM.EVENT.KICKED_OUT, this.kicked.bind(this)), this.tim.on(this.TIM.EVENT.NET_STATE_CHANGE, this.networkChange.bind(this)), [4, this.tim.login({
                    userID: this.userName,
                    userSig: this.userSig
                  })];

                case 1:
                  return (e = o.sent()) ? (e.data.repeatLogin && this.sdkReady(), n(e)) : i({}), [2];
              }
            });
          });
        });
      }, t.prototype.destroy = function () {
        return this.eventBus.events = {}, this.tim.logout();
      }, t.prototype.sendMessage = function (t) {
        var e = this;
        return new Promise(function (n, i) {
          return o(e, void 0, void 0, function () {
            var e, o;
            return r(this, function (r) {
              switch (r.label) {
                case 0:
                  return e = this.tim.createTextMessage({
                    to: this.roomID,
                    conversationType: this.TIM.TYPES.CONV_GROUP,
                    payload: {
                      text: t
                    }
                  }), [4, this.tim.sendMessage(e)];

                case 1:
                  return 0 === (o = r.sent()).code ? n({
                    nick: this.userInfo.nick,
                    avatar: this.userInfo.avatar,
                    message: t
                  }) : i(o), [2];
              }
            });
          });
        });
      }, t.prototype.like = function (t) {
        return o(this, void 0, void 0, function () {
          return r(this, function (e) {
            return [2, this.sendCustomMsgAndEmitEvent("LIKE", t)];
          });
        });
      }, t.prototype.buy = function (t) {
        return o(this, void 0, void 0, function () {
          return r(this, function (e) {
            return [2, this.sendCustomMsgAndEmitEvent("BUY_GOODS", JSON.stringify(t))];
          });
        });
      }, t.prototype.sendCustomMsgAndEmitEvent = function (t, e) {
        return o(this, void 0, void 0, function () {
          var n, o;
          return r(this, function (r) {
            switch (r.label) {
              case 0:
                return n = this.tim.createCustomMessage({
                  to: this.roomID,
                  conversationType: this.TIM.TYPES.CONV_GROUP,
                  priority: this.TIM.TYPES.MSG_PRIORITY_HIGH,
                  payload: {
                    data: t,
                    description: "",
                    extension: e
                  }
                }), [4, this.tim.sendMessage(n)];

              case 1:
                return r.sent(), o = {
                  nick: this.userInfo.nick,
                  avatar: this.userInfo.avatar,
                  value: e,
                  userID: this.userInfo.userID
                }, this.eventBus.emit(t, o), [2, o];
            }
          });
        });
      }, t.prototype.useCoupon = function (t) {
        return o(this, void 0, void 0, function () {
          return r(this, function (e) {
            return [2, this.sendCustomMsgAndEmitEvent("USE_COUPON", t)];
          });
        });
      }, t.prototype.sendGift = function (t) {
        return this.sendCustomMsgAndEmitEvent("SEND_GIFT", t);
      }, t.prototype.exitRoom = function () {
        return o(this, void 0, void 0, function () {
          var t = this;
          return r(this, function (e) {
            return [2, new Promise(function (e, n) {
              return o(t, void 0, void 0, function () {
                var t;
                return r(this, function (o) {
                  switch (o.label) {
                    case 0:
                      return this.userInfo.userID === this.groupInfo.ownerID ? (e(), [2]) : [4, this.tim.quitGroup(this.roomID)];

                    case 1:
                      return 0 === (t = o.sent()).code ? e(t.data) : n(t), [2];
                  }
                });
              });
            })];
          });
        });
      }, t.prototype.joinRoom = function (t) {
        return void 0 === t && (t = {
          getOwnerInfo: !0,
          roomID: ""
        }), o(this, void 0, void 0, function () {
          var e, n, o, i;
          return r(this, function (r) {
            switch (r.label) {
              case 0:
                if (t.roomID) this.roomID = t.roomID;else if (this.roomID) throw new Error("roomID为必填");
                return [4, this.tim.joinGroup({
                  groupID: t.roomID ? t.roomID : this.roomID,
                  type: this.TIM.TYPES.GRP_AVCHATROOM
                })];

              case 1:
                return 0 !== (e = r.sent()).code || "JoinedSuccess" !== e.data.status ? [3, 5] : t.getOwnerInfo ? (n = e.data.group.ownerID, [4, this.getUserInfoByID(n)]) : [3, 3];

              case 2:
                o = r.sent(), e.data.group.ownerInfo = o, r.label = 3;

              case 3:
                return [4, this.getMyProfile()];

              case 4:
                return i = r.sent(), this.groupInfo = e.data.group, [2, {
                  groupInfo: e.data.group,
                  userInfo: i
                }];

              case 5:
                return 0 !== e.code || "AlreadyInGroup" !== e.data.status ? [3, 7] : (this.groupInfo = e.data.group, [4, this.getMyProfile()]);

              case 6:
                return i = r.sent(), [2, {
                  groupInfo: e.data.group,
                  userInfo: i
                }];

              case 7:
                return [2, null];
            }
          });
        });
      }, t.prototype.getRoomInfo = function () {
        return this.getGroupProfile();
      }, t.prototype.getUserInfo = function () {
        return o(this, void 0, void 0, function () {
          return r(this, function (t) {
            return [2, this.getMyProfile()];
          });
        });
      }, t.prototype.attention = function (t) {
        return this.sendCustomMsgAndEmitEvent("ATTENTION", t);
      }, t.prototype.cancelAttention = function (t) {
        return this.sendCustomMsgAndEmitEvent("CANCELATTENTION", t);
      }, t.prototype.on = function (t, e) {
        this.eventBus.on(t, e);
      }, t.prototype.initComponentMemberValue = function (t) {
        for (var e in t) {
          this[e] = t[e];
        }
      }, t.prototype.sdkReady = function () {
        this.eventBus.emit(s["default"].SDK_READY), this.getMyProfile(), this.getGroupProfile();
      }, t.prototype.messageRecieved = function (t) {
        var e = t.data;

        for (var n in e) {
          if ("TIMGroupTipElem" === e[n].type) {
            var o = e[n].payload.operationType;

            if (1 === o) {
              var r = {
                nick: e[n].nick,
                avatar: e[n].avatar,
                userID: e[n].payload.operatorID
              };
              this.eventBus.emit(s["default"].JOIN_GROUP, r);
            }

            if (2 === o) {
              r = {
                nick: e[n].nick,
                avatar: e[n].avatar,
                userID: e[n].payload.operatorID
              };
              this.eventBus.emit(s["default"].EXIT_GROUP, r);
            }

            if (6 === o) if (e[n].payload.newGroupProfile.groupCustomField && e[n].payload.newGroupProfile.groupCustomField.length) {
              var i = e[n].payload.newGroupProfile.groupCustomField[0].key,
                  u = e[n].payload.newGroupProfile.groupCustomField[0].value,
                  a = {
                addgoods: "ADD_GOODS",
                room_status: "ROOM_STATUS_CHANGE",
                add_goods: "ADD_GOODS"
              };
              this.eventBus.emit(a[i] ? a[i] : i, {
                nick: e[n].nick,
                avatar: e[n].avatar,
                userID: e[n].from,
                value: u
              });
            } else e[n].payload.newGroupProfile.notification && this.eventBus.emit(s["default"].NOTIFACATION, {
              notification: e[n].payload.newGroupProfile.notification
            });
          }

          if ("TIMTextElem" === e[n].type) {
            r = {
              nick: e[n].nick,
              avtar: e[n].avatar,
              message: e[n].payload.text,
              userID: e[n].from
            };
            this.eventBus.emit(s["default"].MESSAGE, r);
          }

          "TIMCustomElem" === e[n].type && this.eventBus.emit(e[n].payload.data, {
            nick: e[n].nick,
            avatar: e[n].avatar,
            value: e[n].payload.extension,
            userID: e[n].from
          });
        }
      }, t.prototype.profileUpdate = function (t) {
        this.eventBus.emit(s["default"].PROFILE_UPDATE, t);
      }, t.prototype.error = function (t) {
        this.eventBus.emit(s["default"].ERROR, t);
      }, t.prototype.kicked = function (t) {
        this.eventBus.emit(s["default"].KICKED, t);
      }, t.prototype.networkChange = function (t) {
        this.eventBus.emit(s["default"].NETWORK_CHANGE, t);
      }, t.prototype.sdkNotReady = function (t) {
        this.eventBus.emit(s["default"].SDK_NOT_READY, t);
      }, t.prototype.getMyProfile = function () {
        return o(this, void 0, void 0, function () {
          var t;
          return r(this, function (e) {
            switch (e.label) {
              case 0:
                return [4, this.tim.getMyProfile()];

              case 1:
                return 0 === (t = e.sent()).code ? (this.userInfo = t.data, [2, t.data]) : [2, null];
            }
          });
        });
      }, t.prototype.getGroupProfile = function () {
        return o(this, void 0, void 0, function () {
          var t, e, n;
          return r(this, function (o) {
            switch (o.label) {
              case 0:
                return [4, this.tim.getGroupProfile({
                  groupID: this.roomID,
                  groupCustomFieldFilter: this.groupCustomFieldFilter
                })];

              case 1:
                return 0 !== (t = o.sent()).code ? [3, 3] : (e = t.data.group.ownerID, [4, this.getUserInfoByID(e)]);

              case 2:
                return n = o.sent(), t.data.group.ownerInfo = n, this.groupInfo = t.data.group, [2, t.data.group];

              case 3:
                return [2, null];
            }
          });
        });
      }, t.prototype.getUserInfoByID = function (t) {
        return o(this, void 0, void 0, function () {
          var e;
          return r(this, function (n) {
            switch (n.label) {
              case 0:
                return [4, this.tim.getUserProfile({
                  userIDList: [t]
                })];

              case 1:
                return 0 === (e = n.sent()).code ? [2, e.data[0]] : [2, null];
            }
          });
        });
      }, t.prototype.addAttention = function () {
        return o(this, void 0, void 0, function () {
          var t, e, n;
          return r(this, function (o) {
            switch (o.label) {
              case 0:
                return [4, this.getGroupProfile()];

              case 1:
                return t = o.sent(), e = i._getVarsByKey(t.groupCustomField, "attent"), n = e || 0, [4, this.tim.updateGroupProfile({
                  groupID: this.roomID,
                  groupCustomField: [{
                    key: "attent",
                    value: String(Number(n) + 1)
                  }]
                })];

              case 2:
                return [2, o.sent()];
            }
          });
        });
      }, t.EVENT = s["default"], t;
    }();

    e["default"] = a;
  }, function (t, e, n) {
    "use strict";

    Object.defineProperty(e, "__esModule", {
      value: !0
    });

    e._getVarsByKey = function (t, e) {
      for (var n, o = 0; o < t.length; o++) {
        if (t[o].key === e) {
          n = t[o].value;
          break;
        }
      }

      return n;
    };
  }, function (t, e, n) {
    "use strict";

    var o;
    Object.defineProperty(e, "__esModule", {
      value: !0
    }), function (t) {
      t.SDK_READY = "SDK_READY", t.JOIN_GROUP = "JOIN_GROUP", t.EXIT_GROUP = "EXIT_GROUP", t.NOTIFACATION = "NOTIFACATION", t.MESSAGE = "MESSAGE", t.PROFILE_UPDATE = "PROFILE_UPDATE", t.ERROR = "ERROR", t.KICKED = "KICKED", t.NETWORK_CHANGE = "NETWORK_CHANGE", t.SDK_NOT_READY = "SDK_NOT_READY", t.LIKE = "LIKE", t.BUY_GOODS = "BUY_GOODS", t.USE_COUPON = "USE_COUPON", t.SEND_GIFT = "SEND_GIFT", t.ATTENTION = "ATTENTION", t.CANCELATTENTION = "CANCELATTENTION", t.ADD_GOODS = "ADD_GOODS", t.ROOM_STATUS_CHANGE = "ROOM_STATUS_CHANGE";
    }(o || (o = {})), e["default"] = o;
  }, function (t, e, n) {
    "use strict";

    Object.defineProperty(e, "__esModule", {
      value: !0
    });
    var o = n(5);
    e.EventBus = o["default"];
  }, function (t, e, n) {
    "use strict";

    Object.defineProperty(e, "__esModule", {
      value: !0
    });

    var o = function () {
      function t() {
        this.events = {};
      }

      return t.prototype.on = function (t, e) {
        return this.events[t] = this.events[t] || new Map(), this.events[t].set(e, !1), this;
      }, t.prototype.once = function (t, e) {
        return this.events[t] = this.events[t] || new Map(), this.events[t].set(e, !0), this;
      }, t.prototype.off = function (t, e) {
        var n = this.events[t];
        return n && (e ? n["delete"](e) : delete this.events[t]), this;
      }, t.prototype.emit = function (t) {
        for (var e = [], n = 1; n < arguments.length; n++) {
          e[n - 1] = arguments[n];
        }

        var o = this.events[t];
        return o && o.forEach(function (t, n) {
          n.apply(void 0, e), t && o["delete"](n);
        }), this;
      }, t;
    }();

    e["default"] = o;
  }])["default"];
});