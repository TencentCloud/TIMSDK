module.exports=function(){var e="1.7.3";"function"!=typeof Array.prototype.forEach&&(Array.prototype.forEach=function(e){for(var t=0;t<this.length;t++)e.apply(this,[this[t],t,this])});var t={},n={login:function(){},syncMsgs:function(){},getC2CHistoryMsgs:function(){},syncGroupMsgs:function(){},sendMsg:function(){},logout:function(){},setAutoRead:function(){},getProfilePortrait:function(){},setProfilePortrait:function(){},applyAddFriend:function(){},getPendency:function(){},deletePendency:function(){},responseFriend:function(){},getAllFriend:function(){},deleteFriend:function(){},addBlackList:function(){},getBlackList:function(){},deleteBlackList:function(){},uploadPic:function(){},createGroup:function(){},applyJoinGroup:function(){},handleApplyJoinGroup:function(){},deleteApplyJoinGroupPendency:function(){},quitGroup:function(){},getGroupPublicInfo:function(){},getGroupInfo:function(){},modifyGroupBaseInfo:function(){},destroyGroup:function(){},getJoinedGroupListHigh:function(){},getGroupMemberInfo:function(){},addGroupMember:function(){},modifyGroupMember:function(){},forbidSendMsg:function(){},deleteGroupMember:function(){},getPendencyGroup:function(){},getPendencyReport:function(){},getPendencyGroupRead:function(){},sendCustomGroupNotify:function(){},Msg:function(){},MsgStore:{sessMap:function(){return{}},sessCount:function(){return 0},sessByTypeId:function(){return{}},delSessByTypeId:function(){return!0},resetCookieAndSyncFlag:function(){},downloadMap:{}}};return function(n){var o={VERSION:e,APPID:"537048168",PLAATFORM:"10"},r=!0,i=!0,s={FORMAL:{COMMON:"https://webim.tim.qq.com",PIC:"https://pic.tim.qq.com"},TEST:{COMMON:"https://test.tim.qq.com",PIC:"https://pic.tim.qq.com"}},u={},a={OPEN_IM:"openim",GROUP:"group_open_http_svc",FRIEND:"sns",PROFILE:"profile",RECENT_CONTACT:"recentcontact",PIC:"openpic",BIG_GROUP:"group_open_http_noauth_svc",BIG_GROUP_LONG_POLLING:"group_open_long_polling_http_noauth_svc",IM_OPEN_STAT:"imopenstat",DEL_CHAT:"recentcontact",WEB_IM:"webim"},c={openim:"v4",group_open_http_svc:"v4",sns:"v4",profile:"v4",recentcontact:"v4",openpic:"v4",group_open_http_noauth_svc:"v1",group_open_long_polling_http_noauth_svc:"v1",imopenstat:"v4",webim:"v3"},l={login:1,pic_up:3,apply_join_group:9,create_group:10,longpolling:18,send_group_msg:19,sendmsg:20},p={C2C:"C2C",GROUP:"GROUP"},f={C2C:1,GROUP:2},d={C2C:12e3,GROUP:8898},g={OK:"OK",FAIL:"FAIL"},m=99999,I={TEXT:"TIMTextElem",FACE:"TIMFaceElem",IMAGE:"TIMImageElem",CUSTOM:"TIMCustomElem",SOUND:"TIMSoundElem",FILE:"TIMFileElem",LOCATION:"TIMLocationElem",GROUP_TIP:"TIMGroupTipElem"},M={ORIGIN:1,LARGE:2,SMALL:3},E={JPG:1,JPEG:1,GIF:2,PNG:3,BMP:4,UNKNOWN:255},_={RAW_DATA:0,BASE64_DATA:1},y={BUSSINESS_ID:"10001",AUTH_KEY:"617574686b6579",SERVER_IP:"182.140.186.147",SOUND_SERVER_DOMAIN:"grouptalk.c2c.qq.com"},h={SOUND:2106,FILE:2107},T={IMAGE:1,FILE:2,SHORT_VIDEO:3,SOUND:4},C={APP_VERSION:"2.1",SERVER_VERSION:1},A={C2C:1,GROUP_COMMON:3,GROUP_TIP:4,GROUP_SYSTEM:5,GROUP_TIP2:6,FRIEND_NOTICE:7,PROFILE_NOTICE:8,C2C_COMMON:9,C2C_EVENT:10},S={COMMON:0},G={READED:92,KICKEDOUT:96},F={COMMON:0,LOVEMSG:1,TIP:2,REDPACKET:3},O={REDPACKET:1,COMMON:2,LOVEMSG:3},R={JOIN:1,QUIT:2,KICK:3,SET_ADMIN:4,CANCEL_ADMIN:5,MODIFY_GROUP_INFO:6,MODIFY_MEMBER_INFO:7},N={FACE_URL:1,NAME:2,OWNER:3,NOTIFICATION:4,INTRODUCTION:5},v={JOIN_GROUP_REQUEST:1,JOIN_GROUP_ACCEPT:2,JOIN_GROUP_REFUSE:3,KICK:4,DESTORY:5,CREATE:6,INVITED_JOIN_GROUP_REQUEST:7,QUIT:8,SET_ADMIN:9,CANCEL_ADMIN:10,REVOKE:11,READED:15,CUSTOM:255,INVITED_JOIN_GROUP_REQUEST_AGREE:12},P={FRIEND_ADD:1,FRIEND_DELETE:2,PENDENCY_ADD:3,PENDENCY_DELETE:4,BLACK_LIST_ADD:5,BLACK_LIST_DELETE:6,PENDENCY_REPORT:7,FRIEND_UPDATE:8},U={PROFILE_MODIFY:1},b={OK:0,SIGNATURE_EXPIRATION:11},L={INIT:-1,ON:0,RECONNECT:1,OFF:9999},D={GROUP_MSG:1,C2C_MSG:2,USER_HEAD:3,GROUP_HEAD:4},k={ING:14,STOP:15},w=10,q=L.INIT,B=!1,x=0,K=6e4,H=5e3,z=60008,J=91101,V=10018,Y=null,X=0,j=10,W=0,Q=20,$=[],Z=null,ee=null,te={sdkAppID:null,appIDAt3rd:null,accountType:null,identifier:null,tinyid:null,identifierNick:null,userSig:null,a2:null,contentType:"json",apn:1},ne={},oe=0,re={},ie=0,se=[],ue=[],ae=20,ce=[],le={downloadMap:{}},pe={"[惊讶]":0,"[撇嘴]":1,"[色]":2,"[发呆]":3,"[得意]":4,"[流泪]":5,"[害羞]":6,"[闭嘴]":7,"[睡]":8,"[大哭]":9,"[尴尬]":10,"[发怒]":11,"[调皮]":12,"[龇牙]":13,"[微笑]":14,"[难过]":15,"[酷]":16,"[冷汗]":17,"[抓狂]":18,"[吐]":19,"[偷笑]":20,"[可爱]":21,"[白眼]":22,"[傲慢]":23,"[饿]":24,"[困]":25,"[惊恐]":26,"[流汗]":27,"[憨笑]":28,"[大兵]":29,"[奋斗]":30,"[咒骂]":31,"[疑问]":32,"[嘘]":33,"[晕]":34},fe={},de=new function(){this.formatTimeStamp=function(e,t){if(!e)return 0;var n;t=t||"yyyy-MM-dd hh:mm:ss";var o=new Date(1e3*e),r={"M+":o.getMonth()+1,"d+":o.getDate(),"h+":o.getHours(),"m+":o.getMinutes(),"s+":o.getSeconds()};n=/(y+)/.test(t)?t.replace(RegExp.$1,(o.getFullYear()+"").substr(4-RegExp.$1.length)):t;for(var i in r)new RegExp("("+i+")").test(n)&&(n=n.replace(RegExp.$1,1==RegExp.$1.length?r[i]:("00"+r[i]).substr((""+r[i]).length)));return n},this.groupTypeEn2Ch=function(e){var t=null;switch(e){case"Public":t="公开群";break;case"ChatRoom":t="聊天室";break;case"Private":t="私有群";break;case"AVChatRoom":t="直播聊天室";break;default:t=e}return t},this.groupTypeCh2En=function(e){var t=null;switch(e){case"公开群":t="Public";break;case"聊天室":t="ChatRoom";break;case"私有群":t="Private";break;case"直播聊天室":t="AVChatRoom";break;default:t=e}return t},this.groupRoleEn2Ch=function(e){var t=null;switch(e){case"Member":t="成员";break;case"Admin":t="管理员";break;case"Owner":t="群主";break;default:t=e}return t},this.groupRoleCh2En=function(e){var t=null;switch(e){case"成员":t="Member";break;case"管理员":t="Admin";break;case"群主":t="Owner";break;default:t=e}return t},this.groupMsgFlagEn2Ch=function(e){var t=null;switch(e){case"AcceptAndNotify":t="接收并提示";break;case"AcceptNotNotify":t="接收不提示";break;case"Discard":t="屏蔽";break;default:t=e}return t},this.groupMsgFlagCh2En=function(e){var t=null;switch(e){case"接收并提示":t="AcceptAndNotify";break;case"接收不提示":t="AcceptNotNotify";break;case"屏蔽":t="Discard";break;default:t=e}return t},this.formatText2Html=function(e){var t=e;return t&&(t=this.xssFilter(t),t=t.replace(/ /g,"&nbsp;"),t=t.replace(/\n/g,"<br/>")),t},this.formatHtml2Text=function(e){var t=e;return t&&(t=t.replace(/&nbsp;/g," "),t=t.replace(/<br\/>/g,"\n")),t},this.getStrBytes=function(e){if(null==e||void 0===e)return 0;if("string"!=typeof e)return 0;var t,n,o,r=0;for(n=0,o=e.length;o>n;n++)t=e.charCodeAt(n),r+=127>=t?1:2047>=t?2:65535>=t?3:4;return r},this.xssFilter=function(e){return i&&(e=e.toString(),e=e.replace(/[<]/g,"&lt;"),e=e.replace(/[>]/g,"&gt;"),e=e.replace(/"/g,"&quot;")),e},this.trimStr=function(e){return e?(e=e.toString(),e.replace(/(^\s*)|(\s*$)/g,"")):""},this.validNumber=function(e){return e=e.toString(),e.match(/(^\d{1,8}$)/g)},this.getReturnError=function(e,t){t||(t=-100);var n={ActionStatus:g.FAIL,ErrorCode:t,ErrorInfo:e+"["+t+"]"};return n},this.replaceObject=function(e,t){for(var n in t)if(e[n])if(t[e[n]]=t[n],delete t[n],t[e[n]]instanceof Array)for(var o=t[e[n]].length,r=0;o>r;r++)t[e[n]][r]=this.replaceObject(e,t[e[n]][r]);else"object"==typeof t[e[n]]&&(t[e[n]]=this.replaceObject(e,t[e[n]]));return t}},ge=new function(){var e=!0;this.setOn=function(t){e=t},this.getOn=function(){return e},this.error=function(t){try{e&&console.error(t)}catch(n){}},this.warn=function(t){try{e&&console.warn(t)}catch(n){}},this.info=function(t){try{e&&console.info(t)}catch(n){}},this.debug=function(t){try{e&&console.debug(t)}catch(n){}}},me=function(e){return e||(e=new Date),Math.round(e.getTime()/1e3)},Ie=function(){return ie?ie+=1:ie=Math.round(1e7*Math.random()),ie},Me=function(){return Math.round(4294967296*Math.random())},Ee=function(e,t,n,o,r,i,s){wx.request({url:t,data:n,dataType:"json",method:e,header:{"Content-Type":"application/json"},success:function(e){x=X=0,i&&i(e.data)},fail:function(){setTimeout(function(){var e="请求服务器失败,请检查你的网络是否正常",t=de.getReturnError(e,-2);s&&s(t)},16)}})},_e=function(e,t,n,o,r,i,s){Ee(e,t,JSON.stringify(n),o,r,function(e){var t=null;e&&(t=e),i&&i(t)},s)},ye=function(){return te.sdkAppID&&te.identifier},he=function(e,t){if(!ye()){if(t){var n="请登录",o=de.getReturnError(n,-4);e&&e(o)}return!1}return!0},Te=function(){return r},Ce=function(e,t,n,r){var i=s;i=Te()?s.FORMAL.COMMON:s.TEST.COMMON,e==a.PIC&&(i=Te()?s.FORMAL.PIC:s.TEST.PIC);var u=i+"/"+c[e]+"/"+e+"/"+t+"?websdkappid="+o.APPID+"&v="+o.VERSION+"&platform="+o.PLAATFORM;if(ye()){if("login"==t||"accesslayer"==t)u+="&identifier="+encodeURIComponent(te.identifier)+"&usersig="+te.userSig;else if(te.tinyid&&te.a2)u+="&tinyid="+te.tinyid+"&a2="+te.a2;else if(r)return ge.error("tinyid或a2为空["+e+"]["+t+"]"),r(de.getReturnError("tinyid或a2为空["+e+"]["+t+"]",-5)),!1;u+="&contenttype="+te.contentType}return u+="&sdkappid="+te.sdkAppID+"&accounttype="+te.accountType+"&apn="+te.apn+"&reqtime="+me()},Ae=function(e,t){var n=null;return Z&&$[0]?n="https://"+y.SOUND_SERVER_DOMAIN+"/asn.com/stddownload_common_file?authkey="+Z+"&bid="+y.BUSSINESS_ID+"&subbid="+te.sdkAppID+"&fileid="+e+"&filetype="+h.SOUND+"&openid="+t+"&ver=0":ge.error("拼接语音下载url不报错：ip或者authkey为空"),n},Se=function(e,t,n){var o=null;return Z&&$[0]?o="http://"+$[0]+"/asn.com/stddownload_common_file?authkey="+Z+"&bid="+y.BUSSINESS_ID+"&subbid="+te.sdkAppID+"&fileid="+e+"&filetype="+h.FILE+"&openid="+t+"&ver=0&filename="+encodeURIComponent(n):ge.error("拼接文件下载url不报错：ip或者authkey为空"),le.downloadMap["uuid_"+e]=o,o},Ge=function(e,t,n,o,r,i,s){var u={From_Account:t,To_Account:r,os_platform:10,Timestamp:me().toString(),Random:Me().toString(),request_info:[{busi_id:i,download_flag:o,type:s,uuid:e,version:C.SERVER_VERSION,auth_key:Z,ip:$[0]}]};Ut(u,function(e){0==e.error_code&&e.response_info&&(le.downloadMap["uuid_"+u.uuid]=e.response_info.url),onAppliedDownloadUrl&&onAppliedDownloadUrl({uuid:u.uuid,url:e.response_info.url,maps:le.downloadMap})},function(){ge.error("获取下载地址失败",u.uuid)})},Fe=function(){for(var e in re){var t=re[e];t&&(t.abort(),re[oe]=null)}oe=0,re={}},Oe=function(){Fe(),te={sdkAppID:null,appIDAt3rd:null,accountType:null,identifier:null,identifierNick:null,userSig:null,contentType:"json",apn:1},ne={},ie=0,ce=[],qt.clear(),wt.clear(),Y=null},Re=function(e,t,n,o,s){return Oe(),n&&(ne=n),0==ne.isAccessFormalEnv&&(ge.error("请切换为正式环境！！！！"),r=ne.isAccessFormalEnv),0==ne.isLogOn&&ge.setOn(ne.isLogOn),"undefined"!=typeof ne.xssFilterEnable&&(i=ne.xssFilterEnable),!e&&s?void s(de.getReturnError("loginInfo is empty",-6)):!e.sdkAppID&&s?void s(de.getReturnError("loginInfo.sdkAppID is empty",-7)):(e.identifier&&(te.identifier=e.identifier.toString()),e.identifier&&!e.userSig&&s?void s(de.getReturnError("loginInfo.userSig is empty",-9)):(e.userSig&&(te.userSig=e.userSig.toString()),te.sdkAppID=e.sdkAppID,te.accountType=Math.ceil(1e5*Math.random()),void(te.identifier&&te.userSig?Pe(function(){Ue(function(e,n){qt.init(t,function(t){o&&(t.identifierNick=e,t.headurl=n,o(t))},s)},s)}):qt.init(t,o,s))))},Ne=function(){u="wechat"},ve=function(e,t,n){if("longpolling"!=e||t!=z&&t!=J){var r=l[e];if(r){var i=me(),s=null,u={Code:t,ErrMsg:n};if(te.a2?s=te.a2.substring(0,10)+"_"+i+"_"+Me():te.userSig&&(s=te.userSig.substring(0,10)+"_"+i+"_"+Me()),s){var a={UniqKey:s,EventId:r,ReportTime:i,MsgCmdErrorCode:u};if("login"==e){var c=[];c.push(a);var p={EvtItems:c,MainVersion:o.VERSION,Version:"0"};vt(p,function(){c=null},function(){c=null})}else if(ce.push(a),ce.length>=ae){var f={EvtItems:ce,MainVersion:o.VERSION,Version:"0"};vt(f,function(){ce=[]},function(){ce=[]})}}}}},Pe=function(e){bt.apiCall(a.WEB_IM,"accesslayer",{},function(t){0===t.ErrorCode&&1===t.WebImAccessLayer&&(s.FORMAL.COMMON="https://events.tim.qq.com"),e()},function(){e()})},Ue=function(e,t){bt.apiCall(a.OPEN_IM,"login",{State:"Online"},function(n){if(n.TinyId)te.tinyid=n.TinyId;else if(t)return void t(de.getReturnError("TinyId is empty",-10));if(n.A2Key)te.a2=n.A2Key;else if(t)return void t(de.getReturnError("A2Key is empty",-11));var o=["Tag_Profile_IM_Nick","Tag_Profile_IM_Image"],r={From_Account:te.identifier,To_Account:[te.identifier],LastStandardSequence:0,TagList:o};Ct(r,function(t){var n,o;if(t.UserProfileItem&&t.UserProfileItem.length>0)for(var r in t.UserProfileItem)for(var i in t.UserProfileItem[r].ProfileItem)switch(t.UserProfileItem[r].ProfileItem[i].Tag){case"Tag_Profile_IM_Nick":n=t.UserProfileItem[r].ProfileItem[i].Value,n&&(te.identifierNick=n);break;case"Tag_Profile_IM_Image":o=t.UserProfileItem[r].ProfileItem[i].Value,o&&(te.headurl=o)}e&&e(te.identifierNick,te.headurl)},t)},t)},be=function(e,t,n){return he(n,!1)?void("all"==e?bt.apiCall(a.OPEN_IM,"logout",{},function(e){Oe(),t&&t(e)},n):bt.apiCall(a.OPEN_IM,"longpollinglogout",{LongPollingId:Y},function(e){Oe(),t&&t(e)},n)):(Oe(),void(t&&t({ActionStatus:g.OK,ErrorCode:0,ErrorInfo:"logout success"})))},Le=function(e,t,n){if(he(n,!0)){var o=null;switch(e.sess.type()){case p.C2C:o={From_Account:te.identifier,To_Account:e.sess.id().toString(),MsgTimeStamp:e.time,MsgSeq:e.seq,MsgRandom:e.random,MsgBody:[],OfflinePushInfo:e.offlinePushInfo};break;case p.GROUP:var r=e.getSubType();switch(o={GroupId:e.sess.id().toString(),From_Account:te.identifier,Random:e.random,MsgBody:[]},r){case F.COMMON:o.MsgPriority="COMMON";break;case F.REDPACKET:o.MsgPriority="REDPACKET";break;case F.LOVEMSG:o.MsgPriority="LOVEMSG";break;case F.TIP:ge.error("不能主动发送群提示消息,subType="+r);break;default:return void ge.error("发送群消息时，出现未知子消息类型：subType="+r)}}for(var i in e.elems){var s=e.elems[i],u=null,c=s.type;switch(c){case I.TEXT:u={Text:s.content.text};break;case I.FACE:u={Index:s.content.index,Data:s.content.data};break;case I.IMAGE:var l=[];for(var f in s.content.ImageInfoArray)l.push({Type:s.content.ImageInfoArray[f].type,Size:s.content.ImageInfoArray[f].size,Width:s.content.ImageInfoArray[f].width,Height:s.content.ImageInfoArray[f].height,URL:s.content.ImageInfoArray[f].url});u={ImageFormat:s.content.ImageFormat,UUID:s.content.UUID,ImageInfoArray:l};break;case I.SOUND:ge.warn("web端暂不支持发送语音消息");continue;case I.LOCATION:ge.warn("web端暂不支持发送地理位置消息");continue;case I.FILE:u={UUID:s.content.uuid,FileName:s.content.name,FileSize:s.content.size,DownloadFlag:s.content.downFlag};break;case I.CUSTOM:u={Data:s.content.data,Desc:s.content.desc,Ext:s.content.ext},c=I.CUSTOM;break;default:ge.warn("web端暂不支持发送"+s.type+"消息");continue}e.PushInfoBoolean&&(o.OfflinePushInfo=e.PushInfo),o.MsgBody.push({MsgType:c,MsgContent:u})}e.sess.type()==p.C2C?bt.apiCall(a.OPEN_IM,"sendmsg",o,t,n):e.sess.type()==p.GROUP&&bt.apiCall(a.GROUP,"send_group_msg",o,t,n)}},De=function(e,t,n){(r||"undefined"==typeof stopPolling||1!=stopPolling)&&he(n,!0)&&bt.apiCall(a.OPEN_IM,"longpolling",e,t,n,K,!0)},ke=function(e,t,n,o){bt.apiCall(a.BIG_GROUP_LONG_POLLING,"get_msg",e,t,n,o)},we=function(e,t,n,o){he(o,!0)&&bt.apiCall(a.OPEN_IM,"getmsg",{Cookie:e,SyncFlag:t},function(e){if(e.MsgList&&e.MsgList.length)for(var t in e.MsgList)se.push(e.MsgList[t]);1==e.SyncFlag?we(e.Cookie,e.SyncFlag,n,o):(e.MsgList=se,se=[],n&&n(e))},o)},qe=function(e,t,n,o){if(he(o,!0)){var r=[];for(var i in t){var s={To_Account:t[i].toAccount,LastedMsgTime:t[i].lastedMsgTime};r.push(s)}bt.apiCall(a.OPEN_IM,"msgreaded",{C2CMsgReaded:{Cookie:e,C2CMsgReadedItem:r}},n,o)}},Be=function(e,t,n){he(n,!0)&&bt.apiCall(a.OPEN_IM,"deletemsg",e,t,n)},xe=function(e,t,n){he(n,!0)&&bt.apiCall(a.OPEN_IM,"getroammsg",e,function(o){var r=e.MaxCnt,i=o.Complete,s=o.MaxCnt,u=o.MsgKey,a=o.LastMsgTime;if(o.MsgList&&o.MsgList.length)for(var c in o.MsgList)ue.push(o.MsgList[c]);var l=null;0==i&&r>s&&(l={Peer_Account:e.Peer_Account,MaxCnt:r-s,LastMsgTime:a,MsgKey:u}),l?xe(l,t,n):(o.MsgList=ue,ue=[],t&&t(o))},n)},Ke=function(e,t,n){if(he(n,!0)){for(var o={Type:e.Type,Name:e.Name},r=[],i=0;i<e.MemberList.length;i++)r.push({Member_Account:e.MemberList[i]});o.MemberList=r,e.GroupId&&(o.GroupId=e.GroupId),e.Owner_Account&&(o.Owner_Account=e.Owner_Account),e.Introduction&&(o.Introduction=e.Introduction),e.Notification&&(o.Notification=e.Notification),e.MaxMemberCount&&(o.MaxMemberCount=e.MaxMemberCount),e.ApplyJoinOption&&(o.ApplyJoinOption=e.ApplyJoinOption),e.AppDefinedData&&(o.AppDefinedData=e.AppDefinedData),e.FaceUrl&&(o.FaceUrl=e.FaceUrl),bt.apiCall(a.GROUP,"create_group",o,t,n)}},He=function(e,t,n){he(n,!0)&&bt.apiCall(a.GROUP,"create_group",e,t,n)},ze=function(e,t,n){he(n,!0)&&bt.apiCall(a.GROUP,"modify_group_base_info",e,t,n)},Je=function(e,t,n){he(n,!0)&&(e.GroupId=String(e.GroupId),bt.apiCall(a.GROUP,"apply_join_group",{GroupId:e.GroupId,ApplyMsg:e.ApplyMsg,UserDefinedField:e.UserDefinedField},t,n))},Ve=function(e,t,n){e.GroupId=String(e.GroupId);var o;return o=he(n,!1)?a.GROUP:a.BIG_GROUP,qt.checkBigGroupLongPollingOn(e.GroupId)?void(n&&n(de.getReturnError("Join Group failed; You have already been in this group, you have to quit group before you rejoin",10013))):void bt.apiCall(o,"apply_join_group",{GroupId:e.GroupId,ApplyMsg:e.ApplyMsg,UserDefinedField:e.UserDefinedField},function(o){if(o.JoinedStatus&&"JoinedSuccess"==o.JoinedStatus){if(!o.LongPollingKey)return void(n&&n(de.getReturnError("Join Group succeed; But the type of group is not AVChatRoom: groupid="+e.GroupId,-12)));qt.setBigGroupLongPollingOn(!0),qt.setBigGroupLongPollingKey(e.GroupId,o.LongPollingKey),qt.setBigGroupLongPollingMsgMap(e.GroupId,0),qt.bigGroupLongPolling(e.GroupId)}t&&t(o)},function(e){n&&n(e)})},Ye=function(e,t,n){he(n,!0)&&bt.apiCall(a.GROUP,"handle_apply_join_group",{GroupId:e.GroupId,Applicant_Account:e.Applicant_Account,HandleMsg:e.HandleMsg,Authentication:e.Authentication,MsgKey:e.MsgKey,ApprovalMsg:e.ApprovalMsg,UserDefinedField:e.UserDefinedField},t,function(e){if(10024==e.ErrorCode){if(t){var o={ActionStatus:g.OK,ErrorCode:0,ErrorInfo:"该申请已经被处理过"};t(o)}}else n&&n(e)})},Xe=function(e,t,n){he(n,!0)&&bt.apiCall(a.GROUP,"get_pendency",{StartTime:e.StartTime,Limit:e.Limit,Handle_Account:te.identifier},t,function(){})},je=function(e,t,n){he(n,!0)&&bt.apiCall(a.GROUP,"report_pendency",{ReportTime:e.ReportTime,From_Account:te.identifier},t,function(){})},We=function(e,t,n){he(n,!0)&&bt.apiCall(a.GROUP,"handle_invite_join_group",{GroupId:e.GroupId,Inviter_Account:e.Inviter_Account,HandleMsg:e.HandleMsg,Authentication:e.Authentication,MsgKey:e.MsgKey,ApprovalMsg:e.ApprovalMsg,UserDefinedField:e.UserDefinedField},t,function(){})},Qe=function(e,t,n){he(n,!0)&&bt.apiCall(a.GROUP,"quit_group",{GroupId:e.GroupId},t,n)},$e=function(e,t,n){var o;o=he(n,!1)?a.GROUP:a.BIG_GROUP,qt.resetBigGroupLongPollingInfo(e.GroupId),bt.apiCall(o,"quit_group",{GroupId:e.GroupId},function(n){wt.delSessByTypeId(p.GROUP,e.GroupId),t&&t(n)},n)},Ze=function(e,t,n){bt.apiCall(a.GROUP,"search_group",e,t,n)},et=function(e,t,n){he(n,!0)&&bt.apiCall(a.GROUP,"get_group_public_info",{GroupIdList:e.GroupIdList,ResponseFilter:{GroupBasePublicInfoFilter:e.GroupBasePublicInfoFilter}},function(e){if(e.ErrorInfo="",e.GroupInfo)for(var o in e.GroupInfo){var r=e.GroupInfo[o].ErrorCode;r>0&&(e.ActionStatus=g.FAIL,e.GroupInfo[o].ErrorInfo="["+r+"]"+e.GroupInfo[o].ErrorInfo,e.ErrorInfo+=e.GroupInfo[o].ErrorInfo+"\n")}e.ActionStatus==g.FAIL?n&&n(e):t&&t(e)},n)},tt=function(e,t,n){if(he(n,!0)){var o={GroupIdList:e.GroupIdList,ResponseFilter:{GroupBaseInfoFilter:e.GroupBaseInfoFilter,MemberInfoFilter:e.MemberInfoFilter}};e.AppDefinedDataFilter_Group&&(o.ResponseFilter.AppDefinedDataFilter_Group=e.AppDefinedDataFilter_Group),e.AppDefinedDataFilter_GroupMember&&(o.ResponseFilter.AppDefinedDataFilter_GroupMember=e.AppDefinedDataFilter_GroupMember),bt.apiCall(a.GROUP,"get_group_info",o,t,n)}},nt=function(e,t,n){he(n,!0)&&bt.apiCall(a.GROUP,"get_group_member_info",{GroupId:e.GroupId,Offset:e.Offset,Limit:e.Limit,MemberInfoFilter:e.MemberInfoFilter,MemberRoleFilter:e.MemberRoleFilter,AppDefinedDataFilter_GroupMember:e.AppDefinedDataFilter_GroupMember},t,n)},ot=function(e,t,n){he(n,!0)&&bt.apiCall(a.GROUP,"add_group_member",{GroupId:e.GroupId,Silence:e.Silence,MemberList:e.MemberList},t,n)},rt=function(e,t,n){if(he(n,!0)){var o={};e.GroupId&&(o.GroupId=e.GroupId),e.Member_Account&&(o.Member_Account=e.Member_Account),e.Role&&(o.Role=e.Role),e.MsgFlag&&(o.MsgFlag=e.MsgFlag),e.ShutUpTime&&(o.ShutUpTime=e.ShutUpTime),e.NameCard&&(o.NameCard=e.NameCard),e.AppMemberDefinedData&&(o.AppMemberDefinedData=e.AppMemberDefinedData),bt.apiCall(a.GROUP,"modify_group_member_info",o,t,n)}},it=function(e,t,n){he(n,!0)&&bt.apiCall(a.GROUP,"delete_group_member",{GroupId:e.GroupId,Silence:e.Silence,MemberToDel_Account:e.MemberToDel_Account,Reason:e.Reason},t,n)},st=function(e,t,n){he(n,!0)&&bt.apiCall(a.GROUP,"destroy_group",{GroupId:e.GroupId},t,n)},ut=function(e,t,n){he(n,!0)&&bt.apiCall(a.GROUP,"change_group_owner",e,t,n)},at=function(e,t,n){he(n,!0)&&bt.apiCall(a.GROUP,"get_joined_group_list",{Member_Account:e.Member_Account,Limit:e.Limit,Offset:e.Offset,GroupType:e.GroupType,ResponseFilter:{GroupBaseInfoFilter:e.GroupBaseInfoFilter,SelfInfoFilter:e.SelfInfoFilter}},t,n)},ct=function(e,t,n){he(n,!0)&&bt.apiCall(a.GROUP,"get_role_in_group",{GroupId:e.GroupId,User_Account:e.User_Account},t,n)},lt=function(e,t,n){he(n,!0)&&bt.apiCall(a.GROUP,"forbid_send_msg",{GroupId:e.GroupId,Members_Account:e.Members_Account,ShutUpTime:e.ShutUpTime},t,n)},pt=function(e,t,n){he(n,!0)&&bt.apiCall(a.GROUP,"send_group_system_notification",e,t,n)},ft=function(e,t,n){he(n,!0)&&bt.apiCall(a.GROUP,"group_msg_get",{GroupId:e.GroupId,ReqMsgSeq:e.ReqMsgSeq,ReqMsgNumber:e.ReqMsgNumber},t,n)},dt=function(e,t,n){he(n,!0)&&bt.apiCall(a.GROUP,"msg_read_report",{GroupId:e.GroupId,MsgReadedSeq:e.MsgReadedSeq},t,n)},gt=function(e){var t=[];if(e.Fail_Account&&e.Fail_Account.length&&(t=e.Fail_Account),e.Invalid_Account&&e.Invalid_Account.length)for(var n in e.Invalid_Account)t.push(e.Invalid_Account[n]);if(t.length){e.ActionStatus=g.FAIL,e.ErrorCode=m,e.ErrorInfo="";for(var o in t){var r=t[o];for(var i in e.ResultItem)if(e.ResultItem[i].To_Account==r){var s=e.ResultItem[i].ResultCode;e.ResultItem[i].ResultInfo="["+s+"]"+e.ResultItem[i].ResultInfo,e.ErrorInfo+=e.ResultItem[i].ResultInfo+"\n";break}}}return e},mt=function(e,t,n){he(n,!0)&&bt.apiCall(a.FRIEND,"friend_add",{From_Account:te.identifier,AddFriendItem:e.AddFriendItem},function(e){var o=gt(e);o.ActionStatus==g.FAIL?n&&n(o):t&&t(o)},n)},It=function(e,t,n){he(n,!0)&&bt.apiCall(a.FRIEND,"friend_delete",{From_Account:te.identifier,To_Account:e.To_Account,DeleteType:e.DeleteType},function(e){var o=gt(e);o.ActionStatus==g.FAIL?n&&n(o):t&&t(o)},n)},Mt=function(e,t,n){he(n,!0)&&(1==e.chatType?bt.apiCall(a.DEL_CHAT,"delete",{From_Account:te.identifier,Type:e.chatType,To_Account:e.To_Account},t,n):bt.apiCall(a.DEL_CHAT,"delete",{From_Account:te.identifier,Type:e.chatType,ToGroupid:e.To_Account},t,n))},Et=function(e,t,n){he(n,!0)&&bt.apiCall(a.FRIEND,"pendency_get",{From_Account:te.identifier,PendencyType:e.PendencyType,StartTime:e.StartTime,MaxLimited:e.MaxLimited,LastSequence:e.LastSequence},t,n)},_t=function(e,t,n){he(n,!0)&&bt.apiCall(a.FRIEND,"PendencyReport",{From_Account:te.identifier,LatestPendencyTimeStamp:e.LatestPendencyTimeStamp},t,n)},yt=function(e,t,n){he(n,!0)&&bt.apiCall(a.FRIEND,"pendency_delete",{From_Account:te.identifier,PendencyType:e.PendencyType,To_Account:e.To_Account},function(e){var o=gt(e);o.ActionStatus==g.FAIL?n&&n(o):t&&t(o)},n)},ht=function(e,t,n){he(n,!0)&&bt.apiCall(a.FRIEND,"friend_response",{From_Account:te.identifier,ResponseFriendItem:e.ResponseFriendItem},function(e){var o=gt(e);o.ActionStatus==g.FAIL?n&&n(o):t&&t(o)},n)},Tt=function(e,t,n){he(n,!0)&&bt.apiCall(a.FRIEND,"friend_get_all",{From_Account:te.identifier,TimeStamp:e.TimeStamp,StartIndex:e.StartIndex,GetCount:e.GetCount,LastStandardSequence:e.LastStandardSequence,TagList:e.TagList},t,n)},Ct=function(e,t,n){e.To_Account.length>100&&(e.To_Account.length=100,ge.error("获取用户资料人数不能超过100人")),he(n,!0)&&bt.apiCall(a.PROFILE,"portrait_get",{From_Account:te.identifier,To_Account:e.To_Account,TagList:e.TagList},function(e){var o=[];if(e.Fail_Account&&e.Fail_Account.length&&(o=e.Fail_Account),e.Invalid_Account&&e.Invalid_Account.length)for(var r in e.Invalid_Account)o.push(e.Invalid_Account[r]);if(o.length){e.ActionStatus=g.FAIL,e.ErrorCode=m,e.ErrorInfo="";for(var i in o){var s=o[i];for(var u in e.UserProfileItem)if(e.UserProfileItem[u].To_Account==s){var a=e.UserProfileItem[u].ResultCode;e.UserProfileItem[u].ResultInfo="["+a+"]"+e.UserProfileItem[u].ResultInfo,e.ErrorInfo+="账号:"+s+","+e.UserProfileItem[u].ResultInfo+"\n";break}}}e.ActionStatus==g.FAIL?n&&n(e):t&&t(e)},n)},At=function(e,t,n){he(n,!0)&&bt.apiCall(a.PROFILE,"portrait_set",{From_Account:te.identifier,ProfileItem:e.ProfileItem},function(n){for(var o in e.ProfileItem){var r=e.ProfileItem[o];if("Tag_Profile_IM_Nick"==r.Tag){te.identifierNick=r.Value;break}}t&&t(n)},n)},St=function(e,t,n){he(n,!0)&&bt.apiCall(a.FRIEND,"black_list_add",{From_Account:te.identifier,To_Account:e.To_Account},function(e){var o=gt(e);o.ActionStatus==g.FAIL?n&&n(o):t&&t(o)},n)},Gt=function(e,t,n){he(n,!0)&&bt.apiCall(a.FRIEND,"black_list_delete",{From_Account:te.identifier,To_Account:e.To_Account},function(e){var o=gt(e);o.ActionStatus==g.FAIL?n&&n(o):t&&t(o)},n)},Ft=function(e,t,n){he(n,!0)&&bt.apiCall(a.FRIEND,"black_list_get",{From_Account:te.identifier,StartIndex:e.StartIndex,MaxLimited:e.MaxLimited,LastSequence:e.LastSequence},t,n)},Ot=function(e,t,n){he(n,!0)&&bt.apiCall(a.RECENT_CONTACT,"get",{From_Account:te.identifier,Count:e.Count},t,n)},Rt=function(e,t,n){if(he(n,!0)){var o;o=Te()?"pic_up":"pic_up_test",bt.apiCall(a.PIC,o,{App_Version:C.APP_VERSION,From_Account:te.identifier,To_Account:e.To_Account,Seq:e.Seq,Timestamp:e.Timestamp,Random:e.Random,File_Str_Md5:e.File_Str_Md5,File_Size:e.File_Size,File_Type:e.File_Type,Server_Ver:C.SERVER_VERSION,Auth_Key:Z,Busi_Id:e.Busi_Id,PkgFlag:e.PkgFlag,Slice_Offset:e.Slice_Offset,Slice_Size:e.Slice_Size,Slice_Data:e.Slice_Data},t,n)}},Nt=function(e,t){he(t,!0)&&bt.apiCall(a.OPEN_IM,"authkey",{},e,t)},vt=function(e,t,n){he(n,!0)&&bt.apiCall(a.IM_OPEN_STAT,"web_report",e,t,n)},Pt=function(e,t,n){he(n,!0)&&bt.apiCall(a.OPEN_IM,"getlongpollingid",{},function(e){t&&t(e)},n)},Ut=function(e,t,n){bt.apiCall(a.PIC,"apply_download",e,t,n)};Ne();var bt=new function(){var e=null;this.init=function(t){t&&(e=t)},this.callBack=function(t){e&&e(t)},this.clear=function(){e=null},this.apiCall=function(e,t,n,o,r,i,s){var u=Ce(e,t,o,r);0!=u&&_e("POST",u,n,i,s,function(i){var s=null,a="";"pic_up"==t&&(n.Slice_Data="");var c="\n request url: \n"+u+"\n request body: \n"+JSON.stringify(n)+"\n response: \n"+JSON.stringify(i);i.ActionStatus==g.OK?(ge.info("["+e+"]["+t+"]success: "+c),o&&o(i),s=0,a=""):(s=i.ErrorCode,a=i.ErrorInfo,r&&(i.SrcErrorInfo=i.ErrorInfo,i.ErrorInfo="["+e+"]["+t+"]failed: "+c,("longpolling"!=t||i.ErrorCode!=z)&&ge.error(i.ErrorInfo),r(i))),ve(t,s,a)},function(e){r&&r(e),ve(t,e.ErrorCode,e.ErrorInfo)})}},Lt=function(e,t,n,o,r,i){this._impl={skey:Lt.skey(e,t),type:e,id:t,name:n,icon:o,unread:0,isAutoRead:!1,time:r>=0?r:0,curMaxMsgSeq:i>=0?i:0,msgs:[],isFinished:1}};Lt.skey=function(e,t){return e+t},Lt.prototype.type=function(){return this._impl.type},Lt.prototype.id=function(){return this._impl.id},Lt.prototype.name=function(){return this._impl.name},Lt.prototype.icon=function(){return this._impl.icon},Lt.prototype.unread=function(e){return"undefined"==typeof e?this._impl.unread:void(this._impl.unread=e)},Lt.prototype.isFinished=function(e){return"undefined"==typeof e?this._impl.isFinished:void(this._impl.isFinished=e)},Lt.prototype.time=function(){return this._impl.time},Lt.prototype.curMaxMsgSeq=function(e){return"undefined"==typeof e?this._impl.curMaxMsgSeq:void(this._impl.curMaxMsgSeq=e)},Lt.prototype.msgCount=function(){return this._impl.msgs.length},Lt.prototype.msg=function(e){return this._impl.msgs[e]},Lt.prototype.msgs=function(){return this._impl.msgs},Lt.prototype._impl_addMsg=function(e,t){this._impl.msgs.push(e),e.time>this._impl.time&&(this._impl.time=e.time),e.seq>this._impl.curMaxMsgSeq&&(this._impl.curMaxMsgSeq=e.seq),e.isSend||this._impl.isAutoRead||!t||this._impl.unread++};var Dt=function(e,t){this.toAccount=e,this.lastedMsgTime=t},kt=function(e,t,n,o,r,i,s,u,a){this.sess=e,this.subType=s>=0?s:0,this.fromAccount=i,this.fromAccountNick=u?u:i,this.fromAccountHeadurl=a||null,this.isSend=Boolean(t),this.seq=n>=0?n:Ie(),this.random=o>=0?o:Me(),this.time=r>=0?r:me(),this.elems=[];var c=e.type();switch(c){case p.GROUP:break;case p.C2C:}};kt.prototype.getSession=function(){return this.sess},kt.prototype.getType=function(){return this.subType},kt.prototype.getSubType=function(){return this.subType},kt.prototype.getFromAccount=function(){return this.fromAccount},kt.prototype.getFromAccountNick=function(){return this.fromAccountNick},kt.prototype.getIsSend=function(){return this.isSend},kt.prototype.getSeq=function(){return this.seq},kt.prototype.getTime=function(){return this.time},kt.prototype.getRandom=function(){return this.random},kt.prototype.getElems=function(){return this.elems},kt.prototype.getMsgUniqueId=function(){return this.uniqueId},kt.prototype.addText=function(e){this.addElem(new n.Msg.Elem(I.TEXT,e))},kt.prototype.addFace=function(e){this.addElem(new n.Msg.Elem(I.FACE,e))},kt.prototype.addImage=function(e){this.addElem(new n.Msg.Elem(I.IMAGE,e))},kt.prototype.addLocation=function(e){this.addElem(new n.Msg.Elem(I.LOCATION,e))},kt.prototype.addFile=function(e){this.addElem(new n.Msg.Elem(I.FILE,e))},kt.prototype.addCustom=function(e){this.addElem(new n.Msg.Elem(I.CUSTOM,e))},kt.prototype.addElem=function(e){this.elems.push(e)},kt.prototype.toHtml=function(){var e="";for(var t in this.elems){var n=this.elems[t];e+=n.toHtml()}return e},kt.Elem=function(e,t){this.type=e,this.content=t},kt.Elem.prototype.getType=function(){return this.type},kt.Elem.prototype.getContent=function(){return this.content},kt.Elem.prototype.toHtml=function(){var e;return e=this.content.toHtml()},kt.Elem.Text=function(e){this.text=de.xssFilter(e)},kt.Elem.Text.prototype.getText=function(){return this.text},kt.Elem.Text.prototype.toHtml=function(){return this.text},kt.Elem.Face=function(e,t){this.index=e,this.data=t},kt.Elem.Face.prototype.getIndex=function(){return this.index},kt.Elem.Face.prototype.getData=function(){return this.data},kt.Elem.Face.prototype.toHtml=function(){var e=null,t=pe[this.data],n=fe[t];return n&&n[1]&&(e=n[1]),e?"<img src='"+e+"'/>":this.data},kt.Elem.Location=function(e,t,n){this.latitude=t,this.longitude=e,this.desc=n},kt.Elem.Location.prototype.getLatitude=function(){return this.latitude},kt.Elem.Location.prototype.getLongitude=function(){return this.longitude},kt.Elem.Location.prototype.getDesc=function(){return this.desc},kt.Elem.Location.prototype.toHtml=function(){return"经度="+this.longitude+",纬度="+this.latitude+",描述="+this.desc},kt.Elem.Images=function(e,t){this.UUID=e,"number"!=typeof t&&(t=parseInt(E[t]||E.UNKNOWN,10)),this.ImageFormat=t,this.ImageInfoArray=[]},kt.Elem.Images.prototype.addImage=function(e){this.ImageInfoArray.push(e)},kt.Elem.Images.prototype.toHtml=function(){var e=this.getImage(M.SMALL),t=this.getImage(M.LARGE),n=this.getImage(M.ORIGIN);return t||(t=e),n||(n=e),"<img src='"+e.getUrl()+"#"+t.getUrl()+"#"+n.getUrl()+"' style='CURSOR: hand' id='"+this.getImageId()+"' bigImgUrl='"+t.getUrl()+"' onclick='imageClick(this)' />"},kt.Elem.Images.prototype.getImageId=function(){return this.UUID},kt.Elem.Images.prototype.getImageFormat=function(){return this.ImageFormat},kt.Elem.Images.prototype.getImage=function(e){for(var t in this.ImageInfoArray)if(this.ImageInfoArray[t].getType()==e)return this.ImageInfoArray[t];var n=null;return this.ImageInfoArray.forEach(function(t){t.getType()==e&&(n=t)}),n},kt.Elem.Images.Image=function(e,t,n,o,r){this.type=e,this.size=t,this.width=n,this.height=o,this.url=r},kt.Elem.Images.Image.prototype.getType=function(){return this.type},kt.Elem.Images.Image.prototype.getSize=function(){return this.size},kt.Elem.Images.Image.prototype.getWidth=function(){return this.width},kt.Elem.Images.Image.prototype.getHeight=function(){return this.height},kt.Elem.Images.Image.prototype.getUrl=function(){
return this.url},kt.Elem.Sound=function(e,t,n,o,r,i,s){this.uuid=e,this.second=t,this.size=n,this.senderId=o,this.receiverId=r,this.downFlag=i,this.busiId=s==p.C2C?2:1,2==i&&null!=url?this.downUrl=url:void 0!==this.downFlag&&void 0!==this.busiId?Ge(e,o,t,i,r,this.busiId,T.SOUND):this.downUrl=Ae(e,o,t)},kt.Elem.Sound.prototype.getUUID=function(){return this.uuid},kt.Elem.Sound.prototype.getSecond=function(){return this.second},kt.Elem.Sound.prototype.getSize=function(){return this.size},kt.Elem.Sound.prototype.getSenderId=function(){return this.senderId},kt.Elem.Sound.prototype.getDownUrl=function(){return this.downUrl},kt.Elem.Sound.prototype.toHtml=function(){return"ie"==u.type&&parseInt(u.ver)<=8?"[这是一条语音消息]demo暂不支持ie8(含)以下浏览器播放语音,语音URL:"+this.downUrl:'<audio id="uuid_'+this.uuid+'" src="'+this.downUrl+'" controls="controls" onplay="onChangePlayAudio(this)" preload="none"></audio>'},kt.Elem.File=function(e,t,n,o,r,i,s){this.uuid=e,this.name=t,this.size=n,this.senderId=o,this.receiverId=r,this.downFlag=i,this.busiId=s==p.C2C?2:1,2==i&&null!=url?this.downUrl=url:void 0!==i&&void 0!==this.busiId?Ge(e,o,t,i,r,this.busiId,T.FILE):this.downUrl=Se(e,o,t)},kt.Elem.File.prototype.getUUID=function(){return this.uuid},kt.Elem.File.prototype.getName=function(){return this.name},kt.Elem.File.prototype.getSize=function(){return this.size},kt.Elem.File.prototype.getSenderId=function(){return this.senderId},kt.Elem.File.prototype.getDownUrl=function(){return this.downUrl},kt.Elem.File.prototype.getDownFlag=function(){return this.downFlag},kt.Elem.File.prototype.toHtml=function(){var e,t;return e=this.size,t="Byte",this.size>=1024&&(e=Math.round(this.size/1024),t="KB"),{uuid:this.uuid,name:this.name,size:e,unitStr:t}},kt.Elem.GroupTip=function(e,t,n,o,r,i){this.opType=e,this.opUserId=t,this.groupId=n,this.groupName=o,this.userIdList=r?r:[],this.groupInfoList=[],this.memberInfoList=[],this.groupMemberNum=null,this.userinfo=i?i:[]},kt.Elem.GroupTip.prototype.addGroupInfo=function(e){this.groupInfoList.push(e)},kt.Elem.GroupTip.prototype.addMemberInfo=function(e){this.memberInfoList.push(e)},kt.Elem.GroupTip.prototype.getOpType=function(){return this.opType},kt.Elem.GroupTip.prototype.getOpUserId=function(){return this.opUserId},kt.Elem.GroupTip.prototype.getGroupId=function(){return this.groupId},kt.Elem.GroupTip.prototype.getGroupName=function(){return this.groupName},kt.Elem.GroupTip.prototype.getUserIdList=function(){return this.userIdList},kt.Elem.GroupTip.prototype.getUserInfo=function(){return this.userinfo},kt.Elem.GroupTip.prototype.getGroupInfoList=function(){return this.groupInfoList},kt.Elem.GroupTip.prototype.getMemberInfoList=function(){return this.memberInfoList},kt.Elem.GroupTip.prototype.getGroupMemberNum=function(){return this.groupMemberNum},kt.Elem.GroupTip.prototype.setGroupMemberNum=function(e){return this.groupMemberNum=e},kt.Elem.GroupTip.prototype.toHtml=function(){var e="[群提示消息]",t=w-1;switch(this.opType){case R.JOIN:e+=this.opUserId+"邀请了";for(var n in this.userIdList)if(e+=this.userIdList[n]+",",this.userIdList.length>w&&n==t){e+="等"+this.userIdList.length+"人";break}e+="加入该群";break;case R.QUIT:e+=this.opUserId+"主动退出该群";break;case R.KICK:e+=this.opUserId+"将";for(var n in this.userIdList)if(e+=this.userIdList[n]+",",this.userIdList.length>w&&n==t){e+="等"+this.userIdList.length+"人";break}e+="踢出该群";break;case R.SET_ADMIN:e+=this.opUserId+"将";for(var n in this.userIdList)if(e+=this.userIdList[n]+",",this.userIdList.length>w&&n==t){e+="等"+this.userIdList.length+"人";break}e+="设为管理员";break;case R.CANCEL_ADMIN:e+=this.opUserId+"取消";for(var n in this.userIdList)if(e+=this.userIdList[n]+",",this.userIdList.length>w&&n==t){e+="等"+this.userIdList.length+"人";break}e+="的管理员资格";break;case R.MODIFY_GROUP_INFO:e+=this.opUserId+"修改了群资料：";for(var n in this.groupInfoList){var o=this.groupInfoList[n].getType(),r=this.groupInfoList[n].getValue();switch(o){case N.FACE_URL:e+="群头像为"+r+"; ";break;case N.NAME:e+="群名称为"+r+"; ";break;case N.OWNER:e+="群主为"+r+"; ";break;case N.NOTIFICATION:e+="群公告为"+r+"; ";break;case N.INTRODUCTION:e+="群简介为"+r+"; ";break;default:e+="未知信息为:type="+o+",value="+r+"; "}}break;case R.MODIFY_MEMBER_INFO:e+=this.opUserId+"修改了群成员资料:";for(var n in this.memberInfoList){var i=this.memberInfoList[n].getUserId(),s=this.memberInfoList[n].getShutupTime();if(e+=i+": ",e+=null!=s&&void 0!==s?0==s?"取消禁言; ":"禁言"+s+"秒; ":" shutupTime为空",this.memberInfoList.length>w&&n==t){e+="等"+this.memberInfoList.length+"人";break}}break;case R.READED:Log.info("消息已读同步");break;default:e+="未知群提示消息类型：type="+this.opType}return e},kt.Elem.GroupTip.GroupInfo=function(e,t){this.type=e,this.value=t},kt.Elem.GroupTip.GroupInfo.prototype.getType=function(){return this.type},kt.Elem.GroupTip.GroupInfo.prototype.getValue=function(){return this.value},kt.Elem.GroupTip.MemberInfo=function(e,t){this.userId=e,this.shutupTime=t},kt.Elem.GroupTip.MemberInfo.prototype.getUserId=function(){return this.userId},kt.Elem.GroupTip.MemberInfo.prototype.getShutupTime=function(){return this.shutupTime},kt.Elem.Custom=function(e,t,n){this.data=e,this.desc=t,this.ext=n},kt.Elem.Custom.prototype.getData=function(){return this.data},kt.Elem.Custom.prototype.getDesc=function(){return this.desc},kt.Elem.Custom.prototype.getExt=function(){return this.ext},kt.Elem.Custom.prototype.toHtml=function(){return this.data};var wt=new function(){var e={},n=[];t={},this.cookie="",this.syncFlag=0;var o=function(t){for(var n in e)t(e[n])},r=function(e){var n=!1,o=e.sess._impl.skey,r=[e.isSend+0,e.seq,e.random].join(""),i=t[o]&&t[o][r];return i&&(n=!0),t[o]?t[o][r]={time:e.time}:(t[o]={},t[o][r]={time:e.time}),n};this.sessMap=function(){return e},this.sessCount=function(){return n.length},this.sessByTypeId=function(t,n){var o=Lt.skey(t,n);return void 0===o||null==o?null:e[o]},this.delSessByTypeId=function(n,o){var r=Lt.skey(n,o);return void 0===r||null==r?!1:(e[r]&&(delete e[r],delete t[r]),!0)},this.resetCookieAndSyncFlag=function(){this.cookie="",this.syncFlag=0},this.setAutoRead=function(e,t,n){if(n&&o(function(e){e._impl.isAutoRead=!1}),e&&(e._impl.isAutoRead=t,t))if(e._impl.unread=0,e._impl.type==p.C2C){var r=[];r.push(new Dt(e._impl.id,e._impl.time)),qe(wt.cookie,r,function(){ge.info("[setAutoRead]: c2CMsgReaded success")},function(e){ge.error("[setAutoRead}: c2CMsgReaded failed:"+e.ErrorInfo)})}else if(e._impl.type==p.GROUP){var i={GroupId:e._impl.id,MsgReadedSeq:e._impl.curMaxMsgSeq};dt(i,function(){ge.info("groupMsgReaded success")},function(e){ge.error("groupMsgReaded failed:"+e.ErrorInfo)})}},this.c2CMsgReaded=function(e,t,n){var o=[];o.push(new Dt(e.To_Account,e.LastedMsgTime)),qe(wt.cookie,o,function(e){t&&(ge.info("c2CMsgReaded success"),t(e))},function(e){n&&(ge.error("c2CMsgReaded failed:"+e.ErrorInfo),n(e))})},this.addSession=function(t){e[t._impl.skey]=t},this.delSession=function(t){delete e[t._impl.skey]},this.clear=function(){e={},n=[],t={},this.cookie="",this.syncFlag=0},this.addMsg=function(t,n){if(r(t))return!1;var o=t.sess;return e[o._impl.skey]||this.addSession(o),o._impl_addMsg(t,n),!0},this.updateTimeline=function(){var e=new Array;o(function(t){e.push(t)}),e.sort(function(e,t){return t.time-e.time}),n=e}},qt=new function(){var e=null,t=null,n={1:null,2:null,3:null,4:null,5:null,6:null,7:null,8:null,9:null,10:null,11:null,15:null,255:null,12:null},o={1:null,2:null,3:null,4:null,5:null,6:null,7:null,8:null},r={1:null},i=null,s=!1,u=0,a=0,c=null,l=!1,f={},d=90,m=null,M={},E={92:null,96:null},_=null,y={},h={};this.setLongPollingOn=function(e){s=e},this.getLongPollingOn=function(){return s},this.resetLongPollingInfo=function(){s=!1,u=0,a=0},this.setBigGroupLongPollingOn=function(e){l=e},this.checkBigGroupLongPollingOn=function(e){return!!m[e]},this.setBigGroupLongPollingKey=function(e,t){m[e]=t},this.resetBigGroupLongPollingInfo=function(e){l=!1,f[e]=0,m[e]=null,M[e]={},f[e]["delete"](),m[e]["delete"](),M[e]["delete"]()},this.setBigGroupLongPollingMsgMap=function(e,t){var n=M[e];n?(n=parseInt(n)+t,M[e]=n):M[e]=t},this.clear=function(){t=null,n={1:null,2:null,3:null,4:null,5:null,6:null,7:null,8:null,9:null,10:null,11:null,15:null,255:null,12:null},o={1:null,2:null,3:null,4:null,5:null,6:null,7:null,8:null},r={1:null},e=null,s=!1,u=0,a=0,c=null,l=!1,f={},m={},M={},h={},$=[],Z=null,ee=null};var T=function(e,t){Nt(function(t){$=t.IpList,Z=t.AuthKey,ee=t.ExpireTime,e&&e(t)},function(e){ge.error("initIpAndAuthkey failed:"+e.ErrorInfo),t&&t(e)})},C=function(e,t){var n={Member_Account:te.identifier,Limit:1e3,Offset:0,GroupBaseInfoFilter:["NextMsgSeq"]};at(n,function(t){if(!t.GroupIdList||0==t.GroupIdList.length)return ge.info("initMyGroupMaxSeqs: 目前还没有加入任何群组"),void(e&&e(t));for(var n=0;n<t.GroupIdList.length;n++){var o=t.GroupIdList[n].GroupId,r=t.GroupIdList[n].NextMsgSeq-1;y[o]=r}e&&e(t)},function(e){ge.error("initMyGroupMaxSeqs failed:"+e.ErrorInfo),t&&t(e)})},b=function(e,t){var n=y[e];n?t>n&&(y[e]=t):y[e]=t},D=function(e,t){for(var n in e){var o=e[n];if(o.From_Account){var r=le(o,!1,!0);r&&t.push(r),b(o.ToGroupId,o.MsgSeq)}}return t},w=function(t,n){var o={},r=[],i=99999999,s=-1;for(var u in n){var c=o[n[u].ToGroupId];c||(c=o[n[u].ToGroupId]={min:i,max:s,msgs:[]}),n[u].NoticeSeq>a&&(ge.warn("noticeSeq="+a+",msgNoticeSeq="+n[u].NoticeSeq),a=n[u].NoticeSeq),n[u].Event=t,o[n[u].ToGroupId].msgs.push(n[u]),n[u].MsgSeq<c.min&&(o[n[u].ToGroupId].min=n[u].MsgSeq),n[u].MsgSeq>c.max&&(o[n[u].ToGroupId].max=n[u].MsgSeq)}for(var l in o)r=D(o[l].msgs,r);r.length&&wt.updateTimeline(),e&&r.length&&e(r)},W=function(t,n){var o={},r=[],i=99999999,s=-1;for(var u in n){var c=o[n[u].ToGroupId];c||(c=o[n[u].ToGroupId]={min:i,max:s,msgs:[]}),n[u].NoticeSeq>a&&(ge.warn("noticeSeq="+a+",msgNoticeSeq="+n[u].NoticeSeq),a=n[u].NoticeSeq),n[u].Event=t,o[n[u].ToGroupId].msgs.push(n[u]),n[u].MsgSeq<c.min&&(o[n[u].ToGroupId].min=n[u].MsgSeq),n[u].MsgSeq>c.max&&(o[n[u].ToGroupId].max=n[u].MsgSeq)}for(var l in o)r=D(o[l].msgs,r);r.length&&wt.updateTimeline(),e&&r.length&&e(r)},Q=function(e,t){for(var o in e){var r=e[o],i=r.MsgBody,s=i.ReportType;0==t&&r.NoticeSeq&&r.NoticeSeq>a&&(a=r.NoticeSeq);{r.GroupInfo.To_Account}if(t){var u=r.ToGroupId+"_"+s+"_"+i.Operator_Account,c=h[u];if(c){ge.warn("收到重复的群系统消息：key="+u);continue}h[u]=!0}var l={SrcFlag:0,ReportType:s,GroupId:r.ToGroupId,GroupName:r.GroupInfo.GroupName,Operator_Account:i.Operator_Account,MsgTime:r.MsgTimeStamp,groupReportTypeMsg:i};switch(s){case v.JOIN_GROUP_REQUEST:l.RemarkInfo=i.RemarkInfo,l.MsgKey=i.MsgKey,l.Authentication=i.Authentication,l.UserDefinedField=r.UserDefinedField,l.From_Account=r.From_Account,l.MsgSeq=r.ClientSeq,l.MsgRandom=r.MsgRandom;break;case v.JOIN_GROUP_ACCEPT:case v.JOIN_GROUP_REFUSE:l.RemarkInfo=i.RemarkInfo;break;case v.KICK:case v.DESTORY:case v.CREATE:case v.INVITED_JOIN_GROUP_REQUEST:case v.INVITED_JOIN_GROUP_REQUEST_AGREE:case v.QUIT:case v.SET_ADMIN:case v.CANCEL_ADMIN:case v.REVOKE:break;case v.READED:break;case v.CUSTOM:l.MsgSeq=r.MsgSeq,l.UserDefinedField=i.UserDefinedField;break;default:ge.error("未知群系统消息类型：reportType="+s)}if(t)n[s]?n[s](l):ge.error("未知群系统消息类型：reportType="+s);else if(n[s])if(s==v.READED)for(var p=l.groupReportTypeMsg.GroupReadInfoArray,f=0,d=p.length;d>f;f++){var g=p[f];n[s](g)}else n[s](l)}},ne=function(e,t){var n,r,i;for(var s in e){switch(n=e[s],r=n.PushType,0==t&&n.NoticeSeq&&n.NoticeSeq>a&&(a=n.NoticeSeq),i={Type:r},r){case P.FRIEND_ADD:i.Accounts=n.FriendAdd_Account;break;case P.FRIEND_DELETE:i.Accounts=n.FriendDel_Account;break;case P.PENDENCY_ADD:i.PendencyList=n.PendencyAdd;break;case P.PENDENCY_DELETE:i.Accounts=n.FrienPencydDel_Account;break;case P.BLACK_LIST_ADD:i.Accounts=n.BlackListAdd_Account;break;case P.BLACK_LIST_DELETE:i.Accounts=n.BlackListDel_Account;break;default:ge.error("未知好友系统通知类型：friendNotice="+JSON.stringify(n))}t?r==P.PENDENCY_ADD&&o[r]&&o[r](i):o[r]&&o[r](i)}},oe=function(e,t){var n,o,i;for(var s in e){switch(n=e[s],o=n.PushType,0==t&&n.NoticeSeq&&n.NoticeSeq>a&&(a=n.NoticeSeq),i={Type:o},o){case U.PROFILE_MODIFY:i.Profile_Account=n.Profile_Account,i.ProfileList=n.ProfileList;break;default:ge.error("未知资料系统通知类型：profileNotice="+JSON.stringify(n))}t?o==U.PROFILE_MODIFY&&r[o]&&r[o](i):r[o]&&r[o](i)}},re=function(e){var t=e.MsgBody,o=t.ReportType,r=(e.GroupInfo.To_Account,{SrcFlag:1,ReportType:o,GroupId:e.ToGroupId,GroupName:e.GroupInfo.GroupName,Operator_Account:t.Operator_Account,MsgTime:e.MsgTimeStamp});switch(o){case v.JOIN_GROUP_REQUEST:r.RemarkInfo=t.RemarkInfo,r.MsgKey=t.MsgKey,r.Authentication=t.Authentication,r.UserDefinedField=e.UserDefinedField,r.From_Account=e.From_Account,r.MsgSeq=e.ClientSeq,r.MsgRandom=e.MsgRandom;break;case v.JOIN_GROUP_ACCEPT:case v.JOIN_GROUP_REFUSE:r.RemarkInfo=t.RemarkInfo;break;case v.KICK:case v.DESTORY:case v.CREATE:case v.INVITED_JOIN_GROUP_REQUEST:case v.INVITED_JOIN_GROUP_REQUEST_AGREE:case v.QUIT:case v.SET_ADMIN:case v.CANCEL_ADMIN:case v.REVOKE:break;case v.CUSTOM:r.MsgSeq=e.MsgSeq,r.UserDefinedField=t.UserDefinedField;break;default:ge.error("未知群系统消息类型：reportType="+o)}n[o]&&n[o](r)},ie=function(e){for(var t=0,n=e.length;n>t;t++)se(e[t])},se=function(e){var t=e.SubMsgType;switch(t){case G.READED:if(ge.warn("C2C已读消息通知"),e.ReadC2cMsgNotify&&e.ReadC2cMsgNotify.UinPairReadArray&&E[t])for(var n=0,o=e.ReadC2cMsgNotify.UinPairReadArray.length;o>n;n++){var r=e.ReadC2cMsgNotify.UinPairReadArray[n];E[t](r)}break;case G.KICKEDOUT:ge.warn("多终端互踢通知"),be("instance"),E[t]&&E[t]();break;default:ge.error("未知C2c系统消息：subType="+t)}};this.longPolling=function(e,t){function n(){De(o,function(e){for(var t in e.EventArray){var n=e.EventArray[t];switch(n.Event){case A.C2C:u=n.NotifySeq,ge.warn("longpolling: received new c2c msg"),qt.syncMsgs();break;case A.GROUP_COMMON:ge.warn("longpolling: received new group msgs"),W(n.Event,n.GroupMsgArray);break;case A.GROUP_TIP:ge.warn("longpolling: received new group tips"),W(n.Event,n.GroupTips);break;case A.GROUP_TIP2:ge.warn("longpolling: received new group tips"),W(n.Event,n.GroupTips);break;case A.GROUP_SYSTEM:ge.warn("longpolling: received new group system msgs"),Q(n.GroupTips,!1);break;case A.FRIEND_NOTICE:ge.warn("longpolling: received new friend system notice"),ne(n.FriendListMod,!1);break;case A.PROFILE_NOTICE:ge.warn("longpolling: received new profile system notice"),oe(n.ProfileDataMod,!1);break;case A.C2C_COMMON:a=n.C2cMsgArray[0].NoticeSeq,ge.warn("longpolling: received new c2c_common msg",a),w(n.Event,n.C2cMsgArray);break;case A.C2C_EVENT:a=n.C2cNotifyMsgArray[0].NoticeSeq,ge.warn("longpolling: received new c2c_event msg"),ie(n.C2cNotifyMsgArray);break;default:ge.error("longpolling收到未知新消息类型: Event="+n.Event)}}var o={ActionStatus:g.OK,ErrorCode:0};ue(o)},function(e){ue(e),t&&t(e)})}var o={Timeout:K/1e3,Cookie:{NotifySeq:u,NoticeSeq:a}};Y?(o.Cookie.LongPollingId=Y,n()):Pt({},function(e){Y=o.Cookie.LongPollingId=e.LongPollingId,K=e.Timeout>60?K:1e3*e.Timeout,n()})},this.bigGroupLongPolling=function(e,t,n){var o={USP:1,StartSeq:f[e],HoldTime:d,Key:m[e]};ke(o,function(n){var o=[];if(f[e]=n.NextSeq,d=n.HoldTime,m[e]=n.Key,n.RspMsgList&&n.RspMsgList.length>0){for(var r,i,s,u=0,a=n.RspMsgList.length-1;a>=0;a--){r=n.RspMsgList[a];var p={F_Account:"From_Account",T_Account:"To_Account",FAType:"EnumFrom_AccountType",TAType:"EnumTo_AccountType",GCode:"GroupCode",GName:"GroupName",GId:"GroupId",MFlg:"MsgFlag",FAEInfo:"MsgFrom_AccountExtraInfo",Evt:"Event",GInfo:"GroupInfo",BPlc:"IsPlaceMsg",MBody:"MsgBody",Pri:"MsgPriority",Rdm:"MsgRandom",MSeq:"MsgSeq",TStp:"MsgTimeStamp",TGId:"ToGroupId",UEInfo:"UinExtInfo",UId:"UserId",BSys:"IsSystemMsg",FAHUrl:"From_AccountHeadurl",FANick:"From_AccountNick"};if(r=de.replaceObject(p,r),!r.IsPlaceMsg&&r.From_Account&&r.MsgBody&&0!=r.MsgBody.length)switch(i=r.Event){case A.GROUP_COMMON:ge.info("bigGroupLongPolling: return new group msg"),s=le(r,!1,!1),s&&o.push(s),u+=1;break;case A.GROUP_TIP:case A.GROUP_TIP2:ge.info("bigGroupLongPolling: return new group tip"),s=le(r,!1,!1),s&&o.push(s);break;case A.GROUP_SYSTEM:ge.info("bigGroupLongPolling: new group system msg"),re(r);break;default:ge.error("bigGroupLongPolling收到未知新消息类型: Event="+i)}}u>0&&(qt.setBigGroupLongPollingMsgMap(r.ToGroupId,u),ge.warn("current bigGroupLongPollingMsgMap: "+JSON.stringify(M)))}X=0;var I={ActionStatus:g.OK,ErrorCode:L.ON,ErrorInfo:"connection is ok..."};bt.callBack(I),t?t(o):c&&c(o),l&&qt.bigGroupLongPolling(e)},function(t){t.ErrorCode==V?f[e]=0:t.ErrorCode!=z&&(ge.error(t.ErrorInfo),X++),t.ErrorCode==J&&(ge.error("多实例登录，被kick"),i&&i()),l&&qt.bigGroupLongPolling(e),n&&n(t)},1e3*d)};var ue=function(e){if(0==e.ErrorCode||e.ErrorCode==z){x=0,B=!1;var t,n=!1;switch(q){case L.INIT:n=!0,q=L.ON,t="create connection successfully(INIT->ON)";break;case L.ON:t="connection is on...(ON->ON)";break;case L.RECONNECT:q=L.ON,t="connection is on...(RECONNECT->ON)";break;case L.OFF:n=!0,q=L.RECONNECT,t="reconnect successfully(OFF->RECONNECT)"}var o={ActionStatus:g.OK,ErrorCode:q,ErrorInfo:t};n&&bt.callBack(o),s&&qt.longPolling()}else if(e.ErrorCode==J)ge.error("多实例登录，被kick"),i&&i();else if(x++,ge.warn("longPolling接口第"+x+"次报错: "+e.ErrorInfo),j>=x)setTimeout(ae,100);else{q=L.OFF;var r={ActionStatus:g.FAIL,ErrorCode:L.OFF,ErrorInfo:"connection is off"};0==B&&bt.callBack(r),B=!0,ge.warn(H+"毫秒之后,SDK会发起新的longPolling请求..."),setTimeout(ae,H)}},w=function(t,n){var o=[],r=[];r=n;for(var i in r){var s,u,a=r[i],c=a.From_AccountHeadurl||"";a.From_Account==te.identifier?(s=!0,u=a.To_Account):(s=!1,u=a.From_Account);var l=wt.sessByTypeId(p.C2C,u);l||(l=new Lt(p.C2C,u,u,c,0,0));var f=new kt(l,s,a.MsgSeq,a.MsgRandom,a.MsgTimeStamp,a.From_Account,S.COMMON,a.From_AccountNick,c),d=null,g=null,m=null;for(var M in a.MsgBody){switch(d=a.MsgBody[M],m=d.MsgType){case I.TEXT:g=new kt.Elem.Text(d.MsgContent.Text);break;case I.FACE:g=new kt.Elem.Face(d.MsgContent.Index,d.MsgContent.Data);break;case I.IMAGE:g=new kt.Elem.Images(d.MsgContent.UUID,d.MsgContent.ImageFormat||"");for(var E in d.MsgContent.ImageInfoArray){var _=d.MsgContent.ImageInfoArray[E];g.addImage(new kt.Elem.Images.Image(_.Type,_.Size,_.Width,_.Height,_.URL))}break;case I.SOUND:d.MsgContent?g=new kt.Elem.Sound(d.MsgContent.UUID,d.MsgContent.Second,d.MsgContent.Size,a.From_Account,a.To_Account,d.MsgContent.Download_Flag,p.C2C):(m=I.TEXT,g=new kt.Elem.Text("[语音消息]下载地址解析出错"));break;case I.LOCATION:g=new kt.Elem.Location(d.MsgContent.Longitude,d.MsgContent.Latitude,d.MsgContent.Desc);break;case I.FILE:case I.FILE+" ":m=I.FILE,d.MsgContent?g=new kt.Elem.File(d.MsgContent.UUID,d.MsgContent.FileName,d.MsgContent.FileSize,a.From_Account,a.To_Account,d.MsgContent.Download_Flag,p.C2C):(m=I.TEXT,g=new kt.Elem.Text("[文件消息下载地址解析出错]"));break;case I.CUSTOM:try{var y=JSON.parse(d.MsgContent.Data);if(y&&y.userAction&&y.userAction==k.ING)continue}catch(h){}m=I.CUSTOM,g=new kt.Elem.Custom(d.MsgContent.Data,d.MsgContent.Desc,d.MsgContent.Ext);break;default:m=I.TEXT,g=new kt.Elem.Text("web端暂不支持"+d.MsgType+"消息")}f.elems.push(new kt.Elem(m,g))}f.elems.length>0&&wt.addMsg(f,!0)&&o.push(f)}o.length>0&&wt.updateTimeline(),o.length>0&&e&&e(o)},ae=function(){s&&qt.longPolling()},ce=function(e){for(var t in e){var n=e[t];switch(Q(n.GroupTips,!0),n.Event){case A.GROUP_SYSTEM:ge.warn("handlerApplyJoinGroupSystemMsgs： handler new group system msg"),Q(n.GroupTips,!0);break;default:ge.error("syncMsgs收到未知的群系统消息类型: Event="+n.Event)}}};this.syncMsgs=function(t,n){var o=[],r=[];we(wt.cookie,wt.syncFlag,function(n){2==n.SyncFlag&&(wt.syncFlag=0),r=n.MsgList,wt.cookie=n.Cookie;for(var i in r){var s,u,a,c=r[i];c.From_Account==te.identifier?(s=!0,u=c.To_Account,a=""):(s=!1,u=c.From_Account,a="");var l=wt.sessByTypeId(p.C2C,u);l||(l=new Lt(p.C2C,u,u,a,0,0));var f=new kt(l,s,c.MsgSeq,c.MsgRandom,c.MsgTimeStamp,c.From_Account,S.COMMON,c.From_AccountNick,c.From_AccountHeadurl),d=null,g=null,m=null;for(var M in c.MsgBody){switch(d=c.MsgBody[M],m=d.MsgType){case I.TEXT:g=new kt.Elem.Text(d.MsgContent.Text);break;case I.FACE:g=new kt.Elem.Face(d.MsgContent.Index,d.MsgContent.Data);break;case I.IMAGE:g=new kt.Elem.Images(d.MsgContent.UUID,d.MsgContent.ImageFormat);for(var E in d.MsgContent.ImageInfoArray){var _=d.MsgContent.ImageInfoArray[E];g.addImage(new kt.Elem.Images.Image(_.Type,_.Size,_.Width,_.Height,_.URL))}break;case I.SOUND:d.MsgContent?g=new kt.Elem.Sound(d.MsgContent.UUID,d.MsgContent.Second,d.MsgContent.Size,c.From_Account,c.To_Account,d.MsgContent.Download_Flag,p.C2C):(m=I.TEXT,g=new kt.Elem.Text("[语音消息]下载地址解析出错"));break;case I.LOCATION:g=new kt.Elem.Location(d.MsgContent.Longitude,d.MsgContent.Latitude,d.MsgContent.Desc);break;case I.FILE:case I.FILE+" ":m=I.FILE,d.MsgContent?g=new kt.Elem.File(d.MsgContent.UUID,d.MsgContent.FileName,d.MsgContent.FileSize,c.From_Account,c.To_Account,d.MsgContent.Download_Flag,p.C2C):(m=I.TEXT,g=new kt.Elem.Text("[文件消息下载地址解析出错]"));break;case I.CUSTOM:try{var y=JSON.parse(d.MsgContent.Data);if(y&&y.userAction&&y.userAction==k.ING)continue}catch(h){}m=I.CUSTOM,g=new kt.Elem.Custom(d.MsgContent.Data,d.MsgContent.Desc,d.MsgContent.Ext);break;default:m=I.TEXT,g=new kt.Elem.Text("web端暂不支持"+d.MsgType+"消息")}f.elems.push(new kt.Elem(m,g))}f.elems.length>0&&wt.addMsg(f,!0)&&o.push(f)}ce(n.EventArray),o.length>0&&wt.updateTimeline(),t?t(o):o.length>0&&e&&e(o)},function(e){ge.error("getMsgs failed:"+e.ErrorInfo),n&&n(e)})},this.getC2CHistoryMsgs=function(e,t,n){if(!e.Peer_Account&&n)return void n(de.getReturnError("Peer_Account is empty",-13));if(e.MaxCnt||(e.MaxCnt=15),e.MaxCnt<=0&&n)return void n(de.getReturnError("MaxCnt should be greater than 0",-14));if(e.MaxCnt>15){if(n)return void n(de.getReturnError("MaxCnt can not be greater than 15",-15))}else{(null==e.MsgKey||void 0===e.MsgKey)&&(e.MsgKey="");var o={Peer_Account:e.Peer_Account,MaxCnt:e.MaxCnt,LastMsgTime:e.LastMsgTime,MsgKey:e.MsgKey};xe(o,function(n){var o=[],r=[];r=n.MsgList;var i=wt.sessByTypeId(p.C2C,e.Peer_Account);i||(i=new Lt(p.C2C,e.Peer_Account,e.Peer_Account,"",0,0));for(var s in r){var u,a,c=r[s],l=c.From_AccountHeadurl||"";c.From_Account==te.identifier?(u=!0,a=c.To_Account):(u=!1,a=c.From_Account);var f=new kt(i,u,c.MsgSeq,c.MsgRandom,c.MsgTimeStamp,c.From_Account,S.COMMON,c.From_AccountNick,l),d=null,g=null,m=null;for(var M in c.MsgBody){switch(d=c.MsgBody[M],m=d.MsgType){case I.TEXT:g=new kt.Elem.Text(d.MsgContent.Text);break;case I.FACE:g=new kt.Elem.Face(d.MsgContent.Index,d.MsgContent.Data);break;case I.IMAGE:g=new kt.Elem.Images(d.MsgContent.UUID,d.MsgContent.ImageFormat);for(var E in d.MsgContent.ImageInfoArray){var _=d.MsgContent.ImageInfoArray[E];g.addImage(new kt.Elem.Images.Image(_.Type,_.Size,_.Width,_.Height,_.URL))}break;case I.SOUND:d.MsgContent?g=new kt.Elem.Sound(d.MsgContent.UUID,d.MsgContent.Second,d.MsgContent.Size,c.From_Account,c.To_Account,d.MsgContent.Download_Flag,p.C2C):(m=I.TEXT,g=new kt.Elem.Text("[语音消息]下载地址解析出错"));break;case I.LOCATION:g=new kt.Elem.Location(d.MsgContent.Longitude,d.MsgContent.Latitude,d.MsgContent.Desc);break;case I.FILE:case I.FILE+" ":m=I.FILE,d.MsgContent?g=new kt.Elem.File(d.MsgContent.UUID,d.MsgContent.FileName,d.MsgContent.FileSize,c.From_Account,c.To_Account,d.MsgContent.Download_Flag,p.C2C):(m=I.TEXT,g=new kt.Elem.Text("[文件消息下载地址解析出错]"));break;case I.CUSTOM:m=I.CUSTOM,g=new kt.Elem.Custom(d.MsgContent.Data,d.MsgContent.Desc,d.MsgContent.Ext);break;default:m=I.TEXT,g=new kt.Elem.Text("web端暂不支持"+d.MsgType+"消息")}f.elems.push(new kt.Elem(m,g))}wt.addMsg(f),o.push(f)}if(wt.updateTimeline(),t){var y={Complete:n.Complete,MsgCount:o.length,LastMsgTime:n.LastMsgTime,MsgKey:n.MsgKey,MsgList:o};i.isFinished(n.Complete),t(y)}},function(e){ge.error("getC2CHistoryMsgs failed:"+e.ErrorInfo),n&&n(e)})}},this.syncGroupMsgs=function(t,n,o){if(t.ReqMsgSeq<=0){if(o){var r="ReqMsgSeq must be greater than 0",i=de.getReturnError(r,-16);o(i)}}else{var s={GroupId:t.GroupId,ReqMsgSeq:t.ReqMsgSeq,ReqMsgNumber:t.ReqMsgNumber};ft(s,function(t){var o=[],r=(t.GroupId,t.RspMsgList),i=t.IsFinished;if(null==r||void 0===r)return void(n&&n([]));for(var s=r.length-1;s>=0;s--){var u=r[s];if(!u.IsPlaceMsg&&u.From_Account&&u.MsgBody&&0!=u.MsgBody.length){var a=le(u,!0,!0,i);a&&o.push(a)}}o.length>0&&wt.updateTimeline(),n?n(o):o.length>0&&e&&e(o)},function(e){ge.error("getGroupMsgs failed:"+e.ErrorInfo),o&&o(e)})}};var le=function(e,n,o,r){if(e.IsPlaceMsg||!e.From_Account||!e.MsgBody||0==e.MsgBody.length)return null;var i,s,u,a,c,l=e.ToGroupId,f=l;e.GroupInfo&&e.GroupInfo.GroupName&&(f=e.GroupInfo.GroupName),a=e.From_Account,e.GroupInfo&&(e.GroupInfo.From_AccountNick&&(a=e.GroupInfo.From_AccountNick),c=e.GroupInfo.From_AccountHeadurl?e.GroupInfo.From_AccountHeadurl:null),e.From_Account==te.identifier?(i=!0,s=e.From_Account,u=""):(i=!1,s=e.From_Account,u="");var d=wt.sessByTypeId(p.GROUP,l);d||(d=new Lt(p.GROUP,l,f,u,0,0)),"undefined"!=typeof r&&d.isFinished(r||0);var g=F.COMMON;if(A.GROUP_TIP==e.Event||A.GROUP_TIP2==e.Event){g=F.TIP;var m=e.MsgBody;e.MsgBody=[],e.MsgBody.push({MsgType:I.GROUP_TIP,MsgContent:m})}else e.MsgPriority&&(e.MsgPriority==O.REDPACKET?g=F.REDPACKET:e.MsgPriority==O.LOVEMSG&&(g=F.LOVEMSG));var M=new kt(d,i,e.MsgSeq,e.MsgRandom,e.MsgTimeStamp,e.From_Account,g,a,c),E=null,_=null,y=null;for(var h in e.MsgBody){switch(E=e.MsgBody[h],y=E.MsgType){case I.TEXT:_=new kt.Elem.Text(E.MsgContent.Text);break;case I.FACE:_=new kt.Elem.Face(E.MsgContent.Index,E.MsgContent.Data);break;case I.IMAGE:_=new kt.Elem.Images(E.MsgContent.UUID,E.MsgContent.ImageFormat||"");for(var T in E.MsgContent.ImageInfoArray)_.addImage(new kt.Elem.Images.Image(E.MsgContent.ImageInfoArray[T].Type,E.MsgContent.ImageInfoArray[T].Size,E.MsgContent.ImageInfoArray[T].Width,E.MsgContent.ImageInfoArray[T].Height,E.MsgContent.ImageInfoArray[T].URL));break;case I.SOUND:E.MsgContent?_=new kt.Elem.Sound(E.MsgContent.UUID,E.MsgContent.Second,E.MsgContent.Size,e.From_Account,e.To_Account,E.MsgContent.Download_Flag,p.GROUP):(y=I.TEXT,_=new kt.Elem.Text("[语音消息]下载地址解析出错"));break;case I.LOCATION:_=new kt.Elem.Location(E.MsgContent.Longitude,E.MsgContent.Latitude,E.MsgContent.Desc);break;case I.FILE:case I.FILE+" ":y=I.FILE;{Se(E.MsgContent.UUID,e.From_Account,E.MsgContent.FileName)}E.MsgContent?_=new kt.Elem.File(E.MsgContent.UUID,E.MsgContent.FileName,E.MsgContent.FileSize,e.From_Account,e.To_Account,E.MsgContent.Download_Flag,p.GROUP):(y=I.TEXT,_=new kt.Elem.Text("[文件消息]地址解析出错"));break;case I.GROUP_TIP:var C=E.MsgContent.OpType;if(_=new kt.Elem.GroupTip(C,E.MsgContent.Operator_Account,l,e.GroupInfo.GroupName,E.MsgContent.List_Account,E.MsgContent.MsgMemberExtraInfo),R.JOIN==C||R.QUIT==C)_.setGroupMemberNum(E.MsgContent.MemberNum);else if(R.MODIFY_GROUP_INFO==C){var S=!1,G={GroupId:l,GroupFaceUrl:null,GroupName:null,OwnerAccount:null,GroupNotification:null,GroupIntroduction:null},v=E.MsgContent.MsgGroupNewInfo;if(v.GroupFaceUrl){var P=new kt.Elem.GroupTip.GroupInfo(N.FACE_URL,v.GroupFaceUrl);_.addGroupInfo(P),S=!0,G.GroupFaceUrl=v.GroupFaceUrl}if(v.GroupName){var U=new kt.Elem.GroupTip.GroupInfo(N.NAME,v.GroupName);_.addGroupInfo(U),S=!0,G.GroupName=v.GroupName}if(v.Owner_Account){var b=new kt.Elem.GroupTip.GroupInfo(N.OWNER,v.Owner_Account);_.addGroupInfo(b),S=!0,G.OwnerAccount=v.Owner_Account}if(v.GroupNotification){var L=new kt.Elem.GroupTip.GroupInfo(N.NOTIFICATION,v.GroupNotification);_.addGroupInfo(L),S=!0,G.GroupNotification=v.GroupNotification}if(v.GroupIntroduction){var D=new kt.Elem.GroupTip.GroupInfo(N.INTRODUCTION,v.GroupIntroduction);_.addGroupInfo(D),S=!0,G.GroupIntroduction=v.GroupIntroduction}0==n&&S&&t&&t(G)}else if(R.MODIFY_MEMBER_INFO==C){var k=E.MsgContent.MsgMemberInfo;for(var w in k){var q=k[w];_.addMemberInfo(new kt.Elem.GroupTip.MemberInfo(q.User_Account,q.ShutupTime))}}break;case I.CUSTOM:y=I.CUSTOM,_=new kt.Elem.Custom(E.MsgContent.Data,E.MsgContent.Desc,E.MsgContent.Ext);break;default:y=I.TEXT,_=new kt.Elem.Text("web端暂不支持"+E.MsgType+"消息")}M.elems.push(new kt.Elem(y,_))}return 0==o?M:wt.addMsg(M,!0)?(M.extraInfo=e.GroupInfo.MsgFrom_AccountExtraInfo,M):null};this.init=function(u,a,l){if(u.onMsgNotify||ge.warn("listeners.onMsgNotify is empty"),e=u.onMsgNotify,u.onBigGroupMsgNotify?c=u.onBigGroupMsgNotify:ge.warn("listeners.onBigGroupMsgNotify is empty"),u.onC2cEventNotifys?E=u.onC2cEventNotifys:ge.warn("listeners.onC2cEventNotifys is empty"),u.onGroupSystemNotifys?n=u.onGroupSystemNotifys:ge.warn("listeners.onGroupSystemNotifys is empty"),u.onGroupInfoChangeNotify?t=u.onGroupInfoChangeNotify:ge.warn("listeners.onGroupInfoChangeNotify is empty"),u.onFriendSystemNotifys?o=u.onFriendSystemNotifys:ge.warn("listeners.onFriendSystemNotifys is empty"),u.onProfileSystemNotifys?r=u.onProfileSystemNotifys:ge.warn("listeners.onProfileSystemNotifys is empty"),u.onKickedEventCall?i=u.onKickedEventCall:ge.warn("listeners.onKickedEventCall is empty"),u.onLongPullingNotify?onLongPullingNotify=u.onLongPullingNotify:ge.warn("listeners.onKickedEventCall is empty"),u.onAppliedDownloadUrl?_=u.onAppliedDownloadUrl:ge.warn("listeners.onAppliedDownloadUrl is empty"),te.identifier&&te.userSig)C(function(){ge.info("initMyGroupMaxSeqs success"),T(function(){if(ge.info("initIpAndAuthkey success"),a){ge.info("login success(have login state))");var e={ActionStatus:g.OK,ErrorCode:0,ErrorInfo:"login success"};a(e)}qt.setLongPollingOn(!0),s&&qt.longPolling(a)},l)},l);else if(a){var p={ActionStatus:g.OK,ErrorCode:0,ErrorInfo:"login success(no login state)"};a(p)}},this.sendMsg=function(e,t,n){Le(e,function(o){if(e.sess.type()==p.C2C){if(!wt.addMsg(e)){var r="sendMsg: addMsg failed!",i=de.getReturnError(r,-17);return ge.error(r),void(n&&n(i))}wt.updateTimeline()}t&&t(o)},function(e){n&&n(e)})}},Bt=new function(){this.fileMd5=null;var e=function(e,t,n){function o(){var t=c*u,n=t+u>=e.size?e.size:t+u,o=s.call(e,t,n);r.readAsArrayBuffer(o)}var r=null;try{r=new FileReader}catch(i){if(n)return void n(de.getReturnError("当前浏览器不支持FileReader",-18))}var s=File.prototype.mozSlice||File.prototype.webkitSlice||File.prototype.slice;if(!s&&n)return void n(de.getReturnError("当前浏览器不支持FileAPI",-19));var u=2097152,a=Math.ceil(e.size/u),c=0,l=new SparkMD5;r.onload=function(e){for(var n="",r=new Uint8Array(e.target.result),i=r.byteLength,s=0;i>s;s++)n+=String.fromCharCode(r[s]);l.appendBinary(n),c++,a>c?o():(this.fileMd5=l.end(),t&&t(this.fileMd5))},o()};this.uploadFile=function(t,n,o){var r={init:function(e,t,n){var o=this;o.file=e.file,o.onProgressCallBack=e.onProgressCallBack,e.abortButton&&(e.abortButton.onclick=o.abortHandler),o.total=o.file.size,o.loaded=0,o.step=1105920,o.sliceSize=0,o.sliceOffset=0,o.timestamp=me(),o.seq=Ie(),o.random=Me(),o.fromAccount=te.identifier,o.toAccount=e.To_Account,o.fileMd5=e.fileMd5,o.businessType=e.businessType,o.fileType=e.fileType,o.cbOk=t,o.cbErr=n,o.reader=new FileReader,o.blobSlice=File.prototype.mozSlice||File.prototype.webkitSlice||File.prototype.slice,o.reader.onloadstart=o.onLoadStart,o.reader.onprogress=o.onProgress,o.reader.onabort=o.onAbort,o.reader.onerror=o.onerror,o.reader.onload=o.onLoad,o.reader.onloadend=o.onLoadEnd},upload:function(){var e=r;e.readBlob(0)},onLoadStart:function(){},onProgress:function(e){var t=r;t.loaded+=e.loaded,t.onProgressCallBack&&t.onProgressCallBack(t.loaded,t.total)},onAbort:function(){},onError:function(){},onLoad:function(e){var t=r;if(e.target.readyState==FileReader.DONE){var n=e.target.result,o=n.indexOf(",");-1!=o&&(n=n.substr(o+1));var i={From_Account:t.fromAccount,To_Account:t.toAccount,Busi_Id:t.businessType,File_Type:t.fileType,File_Str_Md5:t.fileMd5,PkgFlag:_.BASE64_DATA,File_Size:t.total,Slice_Offset:t.sliceOffset,Slice_Size:t.sliceSize,Slice_Data:n,Seq:t.seq,Timestamp:t.timestamp,Random:t.random},s=function(e){if(0==e.IsFinish)t.loaded=e.Next_Offset,t.loaded<t.total?t.readBlob(t.loaded):t.loaded=t.total;else if(t.cbOk){var n={ActionStatus:e.ActionStatus,ErrorCode:e.ErrorCode,ErrorInfo:e.ErrorInfo,File_UUID:e.File_UUID,File_Size:e.Next_Offset,URL_INFO:e.URL_INFO,Download_Flag:e.Download_Flag};t.fileType==T.FILE&&(n.URL_INFO=Se(e.File_UUID,te.identifier,t.file.name)),t.cbOk(n)}W=0},u=function(e){Q>W?(W++,setTimeout(function(){Rt(i,s,u)},1e3)):t.cbErr(e);

};Rt(i,s,u)}},onLoadEnd:function(){},readBlob:function(e){var t,n=r,o=n.file,i=e+n.step;i>n.total?(i=n.total,n.sliceSize=i-e):n.sliceSize=n.step,n.sliceOffset=e,t=n.blobSlice.call(o,e,i),n.reader.readAsDataURL(t)},abortHandler:function(){var e=r;e.reader&&e.reader.abort()}};e(t.file,function(e){ge.info("fileMd5: "+e),t.fileMd5=e,r.init(t,n,o),r.upload()},o)}};n.SESSION_TYPE=p,n.MSG_MAX_LENGTH=d,n.C2C_MSG_SUB_TYPE=S,n.GROUP_MSG_SUB_TYPE=F,n.MSG_ELEMENT_TYPE=I,n.GROUP_TIP_TYPE=R,n.IMAGE_TYPE=M,n.GROUP_SYSTEM_TYPE=v,n.FRIEND_NOTICE_TYPE=P,n.GROUP_TIP_MODIFY_GROUP_INFO_TYPE=N,n.BROWSER_INFO=u,n.Emotions=n.EmotionPicData=fe,n.EmotionDataIndexs=n.EmotionPicDataIndex=pe,n.TLS_ERROR_CODE=b,n.CONNECTION_STATUS=L,n.UPLOAD_PIC_BUSSINESS_TYPE=D,n.RECENT_CONTACT_TYPE=f,n.UPLOAD_RES_TYPE=T,n.Tool=de,n.Log=ge,n.Msg=kt,n.Session=Lt,n.MsgStore={sessMap:function(){return wt.sessMap()},sessCount:function(){return wt.sessCount()},sessByTypeId:function(e,t){return wt.sessByTypeId(e,t)},delSessByTypeId:function(e,t){return wt.delSessByTypeId(e,t)},resetCookieAndSyncFlag:function(){return wt.resetCookieAndSyncFlag()}},n.Resources=le,n.login=n.init=function(e,t,n,o,r){bt.init(t.onConnNotify,o,r),Re(e,t,n,o,r)},n.logout=n.offline=function(e,t){return be("instance",e,t)},n.logoutAll=function(e,t){return be("all",e,t)},n.sendMsg=function(e,t,n){return qt.sendMsg(e,t,n)},n.syncMsgs=function(e,t){return qt.syncMsgs(e,t)},n.getC2CHistoryMsgs=function(e,t,n){return qt.getC2CHistoryMsgs(e,t,n)},n.syncGroupMsgs=function(e,t,n){return qt.syncGroupMsgs(e,t,n)},n.c2CMsgReaded=function(e,t,n){return wt.c2CMsgReaded(e,t,n)},n.groupMsgReaded=function(e,t,n){return dt(e,t,n)},n.setAutoRead=function(e,t,n){return wt.setAutoRead(e,t,n)},n.createGroup=function(e,t,n){return Ke(e,t,n)},n.createGroupHigh=function(e,t,n){return He(e,t,n)},n.applyJoinGroup=function(e,t,n){return Je(e,t,n)},n.handleApplyJoinGroupPendency=function(e,t,n){return Ye(e,t,n)},n.getPendencyGroup=function(e,t,n){return Xe(e,t,n)},n.getPendencyGroupRead=function(e,t,n){return je(e,t,n)},n.handleInviteJoinGroupRequest=function(e,t,n){return We(e,t,n)},n.deleteApplyJoinGroupPendency=function(e,t,n){return Be(e,t,n)},n.quitGroup=function(e,t,n){return Qe(e,t,n)},n.searchGroupByName=function(e,t,n){return Ze(e,t,n)},n.getGroupPublicInfo=function(e,t,n){return et(e,t,n)},n.getGroupInfo=function(e,t,n){return tt(e,t,n)},n.modifyGroupBaseInfo=function(e,t,n){return ze(e,t,n)},n.getGroupMemberInfo=function(e,t,n){return nt(e,t,n)},n.addGroupMember=function(e,t,n){return ot(e,t,n)},n.modifyGroupMember=function(e,t,n){return rt(e,t,n)},n.deleteGroupMember=function(e,t,n){return it(e,t,n)},n.destroyGroup=function(e,t,n){return st(e,t,n)},n.changeGroupOwner=function(e,t,n){return ut(e,t,n)},n.getJoinedGroupListHigh=function(e,t,n){return at(e,t,n)},n.getRoleInGroup=function(e,t,n){return ct(e,t,n)},n.forbidSendMsg=function(e,t,n){return lt(e,t,n)},n.sendCustomGroupNotify=function(e,t,n){return pt(e,t,n)},n.applyJoinBigGroup=function(e,t,n){return Ve(e,t,n)},n.quitBigGroup=function(e,t,n){return $e(e,t,n)},n.getProfilePortrait=function(e,t,n){return Ct(e,t,n)},n.setProfilePortrait=function(e,t,n){return At(e,t,n)},n.applyAddFriend=function(e,t,n){return mt(e,t,n)},n.getPendency=function(e,t,n){return Et(e,t,n)},n.getPendencyReport=function(e,t,n){return _t(e,t,n)},n.deletePendency=function(e,t,n){return yt(e,t,n)},n.responseFriend=function(e,t,n){return ht(e,t,n)},n.getAllFriend=function(e,t,n){return Tt(e,t,n)},n.deleteChat=function(e,t,n){return Mt(e,t,n)},n.deleteFriend=function(e,t,n){return It(e,t,n)},n.addBlackList=function(e,t,n){return St(e,t,n)},n.deleteBlackList=function(e,t,n){return Gt(e,t,n)},n.getBlackList=function(e,t,n){return Ft(e,t,n)},n.getRecentContactList=function(e,t,n){return Ot(e,t,n)},n.uploadFile=n.uploadPic=function(e,t,n){return Bt.uploadFile(e,t,n)},n.submitUploadFileForm=function(e,t,n){return Bt.submitUploadFileForm(e,t,n)},n.uploadFileByBase64=n.uploadPicByBase64=function(e,t,n){var o={To_Account:e.toAccount,Busi_Id:e.businessType,File_Type:e.File_Type,File_Str_Md5:e.fileMd5,PkgFlag:_.BASE64_DATA,File_Size:e.totalSize,Slice_Offset:0,Slice_Size:e.totalSize,Slice_Data:e.base64Str,Seq:Ie(),Timestamp:me(),Random:Me()};return Rt(o,t,n)},n.getLongPollingId=function(e,t,n){return Pt(e,t,n)},n.applyDownload=function(e,t,n){return Ut(e,t,n)},n.checkLogin=function(e,t){return he(e,t)}}(n),n}();
