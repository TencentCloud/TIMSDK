require("../../common/manifest.js")
require("../../debug/GenerateTestUserSig.js")
require("../../common/vendor.js")
global.webpackJsonpMpvue([15],{"4USg":function(t,e,s){"use strict";var i=s("Bi6f"),a=s("xEbn");var o=function(t){s("tqfE")},n=s("ybqe")(i.a,a.a,o,"data-v-afeb3abc",null);e.a=n.exports},Bi6f:function(t,e,s){"use strict";var i=s("Dd8w"),a=s.n(i),o=s("NYxO"),n=s("lRgn"),c=s("0xDb"),r=wx.createInnerAudioContext();e.a={data:function(){return{messageContent:"",conversation:{},messageKey:"",lastMsgTime:"",count:15,isEmojiOpen:!1,isMoreOpen:!1,isFocus:!1,isGroup:!1,messageList:[],emojiName:n.b,emojiMap:n.a,emojiUrl:n.c,height:0,modalVisible:!1,downloadInfo:{},percent:0,sysInfo:{},customModalVisible:!1,customData:"",customDescription:"",customExtension:"",safeBottom:34,isIpx:!1}},onLoad:function(t){var e=this;this.set=t.toAccount,wx.setNavigationBarTitle({title:this.set});var s=wx.getSystemInfoSync();this.sysInfo=s,this.height=s.windowHeight,this.isIpx=s.model.indexOf("iPhone X")>-1;var i=wx.createSelectorQuery(),a=this;wx.$app.on(this.TIM.EVENT.MESSAGE_RECEIVED,function(){i.select("#chat").boundingClientRect(function(t){t.bottom-a.height<150&&a.scrollToBottom()}).exec()});var o=setInterval(function(){0!==e.currentMessageList.length&&(e.scrollToBottom(),clearInterval(o))},600);this.$bus.$off("atUser"),this.$bus.$on("atUser",function(t){e.messageContent+=t.userID,e.messageContent+=" "})},onUnload:function(){wx.$app.setMessageRead({conversationID:this.$store.state.conversation.currentConversationID}),this.isEmojiOpen=!1,this.isMoreOpen=!1,this.messageContent="",this.$watch("messageContent",function(t){if("@"===t.slice(-1)){wx.navigateTo({url:"../mention/main?"})}})()},onPullDownRefresh:function(){Object(c.b)(this.getMessageList,1e3)()},computed:a()({},Object(o.b)({currentMessageList:function(t){return t.conversation.currentMessageList}})),methods:{scrollToBottom:function(){wx.pageScrollTo({scrollTop:99999})},customModal:function(){this.customModalVisible=!this.customModalVisible},sendCustomMessage:function(){if(0!==this.customData.length||0!==this.customDescription.length||0!==this.customExtension.length){var t=wx.$app.createCustomMessage({to:this.$store.getters.toAccount,conversationType:this.$store.getters.currentConversationType,payload:{data:this.customData,description:this.customDescription,extension:this.customExtension}});this.$store.commit("sendMessage",t),wx.$app.sendMessage(t),this.customModal(),this.customData="",this.customDescription="",this.customExtension=""}else this.$store.commit("showToast",{title:"不能为空"})},loseFocus:function(){this.handleClose()},handleModalShow:function(){this.modalVisible=!this.modalVisible},handleDownload:function(t){this.percent=0,this.downloadInfo=t,this.handleModalShow()},download:function(){var t=this,e=wx.downloadFile({url:t.downloadInfo.fileUrl,success:function(t){console.log("start downloading: ",t)},fail:function(e){var s=e.errMsg;console.log("downloadFile fail, err is:",s),t.$store.commit("showToast",{title:"文件下载出错",icon:"none",duration:1500}),t.handleModalShow()},complete:function(s){e=null,wx.openDocument({filePath:s.tempFilePath,success:function(e){console.log("open file fail",e),t.$store.commit("showToast",{title:"打开文档成功",icon:"none",duration:1e3}),t.percent=0,t.handleModalShow()},fail:function(e){console.log("open file fail",e),t.$store.commit("showToast",{title:"小程序不支持该文件预览哦",icon:"none",duration:2e3}),t.handleModalShow()}})}});e.onProgressUpdate(function(e){t.percent=e.progress})},toDetail:function(){var t=this,e=this.$store.state.conversation.currentConversationID;if(this.isGroup=0===e.indexOf(this.TIM.TYPES.CONV_GROUP),this.isGroup){wx.navigateTo({url:"../groupDetail/main"})}else{var s={userIDList:[e.substring(3)]};wx.$app.getUserProfile(s).then(function(e){var s=e.data[0];switch(s.gender){case t.TIM.TYPES.GENDER_UNKNOWN:s.gender=t.$type.GENDER_UNKNOWN;break;case t.TIM.TYPES.GENDER_MALE:s.gender=t.$type.GENDER_MALE;break;case t.TIM.TYPES.GENDER_FEMALE:s.gender=t.$type.GENDER_FEMALE}t.$store.commit("updateUserProfile",s);wx.navigateTo({url:"../detail/main"})})}},getMessageList:function(){this.$store.dispatch("getMessageList"),wx.stopPullDownRefresh()},handleEmoji:function(){this.isFocus?(this.isFocus=!1,this.isEmojiOpen=!0):(this.isEmojiOpen=!this.isEmojiOpen,this.isMoreOpen=!1)},handleMore:function(){this.isFocus?(this.isFocus=!1,this.isMoreOpen=!0):(this.isMoreOpen=!this.isMoreOpen,this.isEmojiOpen=!1)},handleClose:function(){this.isFocus=!1,this.isMoreOpen=!1,this.isEmojiOpen=!1},isnull:function(t){if(""===t)return!0;return new RegExp("^[ ]+$").test(t)},sendMessage:function(){var t=this;if(this.isnull(this.messageContent))this.$store.commit("showToast",{title:"消息不能为空"});else{var e=wx.$app.createTextMessage({to:this.$store.getters.toAccount,conversationType:this.$store.getters.currentConversationType,payload:{text:this.messageContent}}),s=this.$store.state.conversation.currentMessageList.length;this.$store.commit("sendMessage",e),wx.$app.sendMessage(e).catch(function(){t.$store.commit("changeMessageStatus",s)}),this.messageContent=""}this.isFocus=!1,this.isEmojiOpen=!1,this.isMoreOpen=!1},sendPhoto:function(t){var e=this;"album"===t?this.chooseImage(t):"camera"===t&&wx.getSetting({success:function(s){s.authSetting["scope.camera"]?e.chooseImage(t):wx.authorize({scope:"scope.camera",success:function(){e.chooseImage(t)}})}})},chooseImage:function(t){var e=this,s={};wx.chooseImage({sourceType:[t],count:1,success:function(t){s=wx.$app.createImageMessage({to:e.$store.getters.toAccount,conversationType:e.$store.getters.currentConversationType,payload:{file:t},onProgress:function(t){e.percent=t}}),e.$store.commit("sendMessage",s),wx.$app.sendMessage(s).then(function(){e.percent=0}).catch(function(t){console.log(t)})}}),this.handleClose()},previewImage:function(t){wx.previewImage({current:t,urls:[t]})},chooseEmoji:function(t){this.messageContent+=t},handleResend:function(t){"fail"===t.status&&wx.$app.resendMessage(t)},dice:function(){var t=wx.$app.createCustomMessage({to:this.$store.getters.toAccount,conversationType:this.$store.getters.currentConversationType,payload:{data:"dice",description:String((10*Math.random()).toFixed(0)%6+1),extension:""}});this.$store.commit("sendMessage",t),wx.$app.sendMessage(t),this.handleClose()},openAudio:function(t){var e=this;r.src=t.url,r.play(),r.onPlay(function(){}),r.onEnded(function(){wx.hideToast()}),r.onError(function(){e.$store.commit("showToast",{title:"小程序暂不支持播放该音频格式",icon:"none",duration:2e3})})}},mounted:function(){this.$watch("messageContent",function(t){if(this.$store.state.conversation.currentConversation.type===this.TIM.TYPES.CONV_GROUP&&"@"===t.slice(-1)){wx.navigateTo({url:"../mention/main"})}})}}},cSaW:function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=s("5nAL"),a=s.n(i),o=s("4USg");new a.a(o.a).$mount()},tqfE:function(t,e){},xEbn:function(t,e,s){"use strict";var i={render:function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"chat",style:{paddingBottom:t.isIpx?t.safeBottom+40+"px":"40px"},attrs:{id:"chat"}},[s("div",{staticClass:"nav",attrs:{eventid:"0"},on:{click:t.toDetail}},[t._v("\n      查看资料\n    ")]),t._v(" "),s("i-modal",{attrs:{title:"确认下载？",visible:t.modalVisible,eventid:"1",mpcomid:"0"},on:{ok:t.download,cancel:t.handleModalShow}},[s("div",{staticClass:"input-wrapper"},[t._v("\n        进度"+t._s(t.percent)+"%\n      ")])]),t._v(" "),s("i-modal",{attrs:{title:"发送自定义消息","i-class":"custom-modal",visible:t.customModalVisible,eventid:"5",mpcomid:"1"},on:{ok:t.sendCustomMessage,cancel:t.customModal}},[s("div",{staticClass:"custom-wrapper"},[s("input",{directives:[{name:"model",rawName:"v-model.lazy:value",value:t.customData,expression:"customData",modifiers:{"lazy:value":!0}}],staticClass:"custom-input",attrs:{type:"text",placeholder:"输入数据",eventid:"2"},domProps:{value:t.customData},on:{input:function(e){e.target.composing||(t.customData=e.target.value)}}}),t._v(" "),s("input",{directives:[{name:"model",rawName:"v-model.lazy:value",value:t.customDescription,expression:"customDescription",modifiers:{"lazy:value":!0}}],staticClass:"custom-input",attrs:{type:"text",placeholder:"输入描述",eventid:"3"},domProps:{value:t.customDescription},on:{input:function(e){e.target.composing||(t.customDescription=e.target.value)}}}),t._v(" "),s("input",{directives:[{name:"model",rawName:"v-model.lazy:value",value:t.customExtension,expression:"customExtension",modifiers:{"lazy:value":!0}}],staticClass:"custom-input",attrs:{type:"text",placeholder:"输入其他",eventid:"4"},domProps:{value:t.customExtension},on:{input:function(e){e.target.composing||(t.customExtension=e.target.value)}}})])]),t._v(" "),s("div",{attrs:{id:"list",eventid:"10"},on:{click:t.loseFocus}},t._l(t.currentMessageList,function(e,i){return s("li",{key:e.ID,attrs:{id:e.ID}},["TIMGroupTipElem"===e.type||"TIMGroupSystemNoticeElem"===e.type?s("div",{staticClass:"notice"},[s("div",{staticClass:"content"},t._l(e.virtualDom,function(i,a){return s("span",{key:e.ID+a},[(i.name,s("span",[t._v(t._s(i.text))]))])}))]):s("div",{class:"out"===e.flow?"item-right":"item-left"},[s("div",{staticClass:"load",attrs:{eventid:"6_"+i},on:{click:function(s){t.handleResend(e)}}},[s("div",{class:e.status})]),t._v(" "),s("div",{staticClass:"content"},[s("div",{staticClass:"name"},[t._v("\n              "+t._s(e.nick||e.from)+"\n            ")]),t._v(" "),"TIMTextElem"===e.type?s("div",{staticClass:"message"},[s("div",{staticClass:"text-message"},t._l(e.virtualDom,function(i,a){return s("span",{key:e.ID+a},["span"===i.name?s("span",[t._v(t._s(i.text))]):t._e(),t._v(" "),"img"===i.name?s("image",{staticStyle:{width:"20px",height:"20px"},attrs:{src:i.src}}):t._e()])}))]):"TIMImageElem"===e.type?s("div",{staticClass:"message",attrs:{eventid:"7_"+i},on:{click:function(s){t.previewImage(e.payload.imageInfoArray[1].url)}}},[s("image",{staticClass:"img",staticStyle:{"max-width":"200px",height:"150px"},attrs:{src:e.payload.imageInfoArray[1].url,mode:"aspectFit"}})]):"TIMFileElem"===e.type?s("div",{staticClass:"message"},[s("div",{staticClass:"file",attrs:{eventid:"8_"+i},on:{click:function(s){t.handleDownload(e.payload)}}},[s("i-avatar",{attrs:{src:"../../../static/images/file.png",size:"large",shape:"square",mpcomid:"2_"+i}}),t._v(" "),s("div",[t._v(t._s(e.payload.fileName))])],1)]):"TIMCustomElem"===e.type?s("div",{staticClass:"message"},["dice"===e.payload.data?s("div",[s("image",{staticStyle:{height:"40px",width:"40px"},attrs:{src:"/static/images/dice"+e.payload.description+".png"}})]):s("div",{staticClass:"custom-elem"},[t._v("这是自定义消息")])]):"TIMSoundElem"===e.type?s("div",{staticClass:"message",attrs:{url:e.payload.url}},[s("div",{staticClass:"box",attrs:{eventid:"9_"+i},on:{click:function(s){t.openAudio(e.payload)}}},[s("image",{staticStyle:{height:"20px",width:"14px"},attrs:{src:"/static/images/audio.png"}}),t._v(" "),s("div",{staticStyle:{"padding-left":"10px"}},[t._v(t._s(e.payload.second)+"s")])])]):"TIMFaceElem"===e.type?s("div",{staticClass:"message"},[s("div",{staticClass:"custom-elem"},[s("image",{staticStyle:{height:"90px",width:"90px"},attrs:{src:"https://imgcache.qq.com/open/qcloud/tim/assets/face-elem/"+e.payload.data+".png"}})])]):t._e()]),t._v(" "),s("div",{staticClass:"avatar"},[s("i-avatar",{attrs:{src:e.avatar||"../../../static/images/header.png",shape:"square",mpcomid:"3_"+i}})],1)])])})),t._v(" "),s("div",{staticClass:"bottom",style:{paddingBottom:t.isIpx?t.safeBottom+"px":""}},[s("div",{staticClass:"bottom-div"},[s("input",{directives:[{name:"model",rawName:"v-model.lazy:value",value:t.messageContent,expression:"messageContent",modifiers:{"lazy:value":!0}}],staticClass:"input",attrs:{type:"text","confirm-type":"send",focus:t.isFocus,eventid:"11"},domProps:{value:t.messageContent},on:{confirm:t.sendMessage,input:function(e){e.target.composing||(t.messageContent=e.target.value)}}}),t._v(" "),s("div",{staticClass:"btn",attrs:{eventid:"12"},on:{click:function(e){t.handleEmoji()}}},[s("image",{staticClass:"btn-small",attrs:{src:"/static/images/emoji.png"}})]),t._v(" "),s("div",{staticClass:"btn",attrs:{eventid:"13"},on:{click:function(e){t.handleMore()}}},[s("image",{staticClass:"btn-small",attrs:{src:"/static/images/plus.png"}})])]),t._v(" "),t.isEmojiOpen?s("div",{staticClass:"bottom-emoji"},[s("div",{staticClass:"emojis"},t._l(t.emojiName,function(e,i){return s("div",{key:e,staticClass:"emoji",attrs:{eventid:"14_"+i},on:{click:function(s){t.chooseEmoji(e)}}},[s("image",{staticStyle:{width:"25px",height:"25px"},attrs:{src:t.emojiUrl+t.emojiMap[e]}})])})),t._v(" "),s("div",{staticClass:"emoji-tab"},[s("i-row",{attrs:{mpcomid:"6"}},[s("i-col",{attrs:{span:"21",mpcomid:"4"}},[s("div",{staticStyle:{"line-height":"26px"}},[t._v("\n                😄\n              ")])]),t._v(" "),s("i-col",{attrs:{span:"3",mpcomid:"5"}},[s("div",{staticClass:"sending",attrs:{eventid:"15"},on:{click:function(e){t.sendMessage()}}},[t._v("发送")])])],1)],1)]):t._e(),t._v(" "),t.isMoreOpen?s("div",{staticClass:"bottom-image"},[s("div",{staticClass:"images"},[s("div",{staticClass:"block",attrs:{eventid:"16"},on:{click:function(e){t.sendPhoto("album")}}},[t._m(0),t._v(" "),s("div",{staticClass:"name"},[t._v("\n              图片\n            ")])]),t._v(" "),s("div",{staticClass:"block",attrs:{eventid:"17"},on:{click:function(e){t.sendPhoto("camera")}}},[t._m(1),t._v(" "),s("div",{staticClass:"name"},[t._v("\n              拍照\n            ")])]),t._v(" "),s("div",{staticClass:"block",attrs:{eventid:"18"},on:{click:function(e){t.customModal()}}},[t._m(2),t._v(" "),s("div",{staticClass:"name"},[t._v("\n              自定义消息\n            ")])]),t._v(" "),s("div",{staticClass:"block",attrs:{eventid:"19"},on:{click:function(e){t.dice()}}},[t._m(3),t._v(" "),s("div",{staticClass:"name"},[t._v("\n              掷骰子\n            ")])])])]):t._e()])],1)},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"image"},[e("image",{staticStyle:{width:"30px",height:"30px"},attrs:{src:"/static/images/image.png"}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"image"},[e("image",{staticStyle:{width:"30px",height:"30px"},attrs:{src:"/static/images/photo.png"}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"image"},[e("image",{staticStyle:{width:"30px",height:"30px"},attrs:{src:"/static/images/define.png"}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"image"},[e("image",{staticStyle:{width:"30px",height:"30px"},attrs:{src:"/static/images/dice.png"}})])}]};e.a=i}},["cSaW"]);